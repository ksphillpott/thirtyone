<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>THIRTY-ONE</title><style>:root{--bg:#111827;--bg2:#1f2937;--bg3:#374151;--border:rgba(255,255,255,0.1);--text:#f1f5f9;--text2:#94a3b8;--gold:#fbbf24;--green:#22c55e;--blue:#3b82f6;--red:#ef4444;--purple:#9333ea;--orange:#f97316;--cyan:#06b6d4;--pink:#ec4899}*{box-sizing:border-box;margin:0;padding:0;-webkit-user-select:none;user-select:none;-webkit-touch-callout:none;-webkit-tap-highlight-color:transparent}body{font-family:system-ui,sans-serif;background:var(--bg);min-height:100dvh;color:var(--text);overflow-x:hidden;touch-action:manipulation}.screen{display:none;min-height:100dvh;flex-direction:column;align-items:center;justify-content:center;padding:16px}.screen.active{display:flex}h1,h2{font-weight:700;margin-bottom:8px}.btn{padding:12px 24px;font-size:1rem;font-weight:600;border:none;border-radius:10px;cursor:pointer;margin:4px}.btn:active{transform:scale(.95)}.btn:disabled{opacity:.5;cursor:not-allowed}.btn-primary{background:var(--blue);color:#fff}.btn-success{background:var(--green);color:#fff}.btn-danger{background:var(--red);color:#fff}.btn-secondary{background:var(--bg3);color:var(--text)}.btn-gold{background:var(--gold);color:#000}.btn-sm{padding:8px 14px;font-size:.85rem}.game-wrap{width:100%;max-width:420px;margin:0 auto;padding:8px;display:flex;flex-direction:column;min-height:100dvh}.header{display:flex;flex-wrap:wrap;gap:6px;padding:10px;background:var(--bg2);border-radius:10px;margin-bottom:6px;align-items:center;justify-content:space-between}.stat{background:var(--bg3);border-radius:6px;padding:4px 8px;text-align:center;min-width:44px}.stat-lbl{font-size:.55rem;color:var(--text2);text-transform:uppercase}.stat-val{font-size:1rem;font-weight:700}.gold{color:var(--gold)}.green{color:var(--green)}.red{color:var(--red)}.hearts{display:flex;gap:2px}.heart{width:18px;height:18px}.heart.on{color:var(--red)}.heart.off{color:var(--bg3)}.card{width:56px;height:78px;border-radius:6px;position:relative;cursor:pointer;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.25);display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:700;transition:transform .15s}.card.sel{transform:translateY(-8px);box-shadow:0 0 0 2px var(--gold)}.card.cursed{filter:hue-rotate(180deg) brightness(.75)}.card.gilded{box-shadow:0 0 12px var(--gold)}.card.wild{box-shadow:0 0 12px var(--purple)}.card.glass{opacity:.8;box-shadow:0 0 12px var(--cyan)}.card.mult{box-shadow:0 0 12px var(--red)}.card .suit{font-size:1.4rem;line-height:1}.card.red{color:#dc2626}.card.black{color:#1f2937}.card .mini{position:absolute;top:3px;left:4px;font-size:.5rem;display:flex;flex-direction:column;align-items:center;line-height:1}.card .mini-b{position:absolute;bottom:3px;right:4px;font-size:.5rem;display:flex;flex-direction:column;align-items:center;line-height:1;transform:rotate(180deg)}.card-val{position:absolute;bottom:1px;right:1px;background:rgba(0,0,0,.8);color:#fff;font-size:.55rem;font-weight:700;padding:1px 3px;border-radius:3px}.card-upgrade{position:absolute;top:1px;right:1px;font-size:.45rem;padding:1px 3px;border-radius:2px;font-weight:700}.deck-back{width:56px;height:78px;border-radius:6px;background:linear-gradient(135deg,#1e3a8a,#312e81);border:2px solid #3b82f6;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer}.deck-back.off{opacity:.5;cursor:not-allowed}.deck-lbl{font-size:.5rem;color:rgba(255,255,255,.5)}.deck-num{font-size:1.1rem;font-weight:700;color:#fff}.discard{width:56px;height:78px;border-radius:6px;border:2px dashed var(--border);display:flex;flex-direction:column;align-items:center;justify-content:center;position:relative;cursor:pointer;background:var(--bg2)}.discard.has{border:none;background:#fff}.discard.free{box-shadow:0 0 0 2px var(--green)}.discard-cnt{position:absolute;top:1px;left:1px;background:rgba(0,0,0,.75);color:#fff;font-size:.5rem;padding:1px 3px;border-radius:3px;z-index:1}.discard-free{position:absolute;bottom:0;left:0;right:0;background:var(--green);color:#fff;font-size:.5rem;text-align:center;padding:1px;z-index:1}.hand-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px 0}.hand{display:flex;gap:5px;flex-wrap:wrap;justify-content:center;margin-bottom:10px;min-height:84px}.score-box{text-align:center;margin-bottom:10px}.score-num{font-size:2.5rem;font-weight:700}.score-num.bust{color:var(--red)}.score-num.hit{color:var(--green)}.score-num.danger{animation:dangerPulse 0.8s ease-in-out infinite}@keyframes dangerPulse{0%,100%{color:var(--text);opacity:1}50%{color:var(--red);opacity:0.7}}.score-lbl{font-size:.7rem;color:var(--text2)}.deck-area{display:flex;gap:14px;justify-content:center;padding:10px 0}.actions{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:6px}.ind-row{display:flex;gap:5px;justify-content:center;flex-wrap:wrap;margin:6px 0}.ind{background:var(--bg3);border-radius:6px;padding:5px 8px;display:flex;align-items:center;gap:3px;font-size:.65rem}.ind.on{background:var(--green);color:#fff}.ind.glow{box-shadow:0 0 8px var(--gold)}.color-sq{width:14px;height:14px;border-radius:2px}.color-sq.red-c{background:#dc2626}.color-sq.black-c{background:#374151}.settings-btn{position:fixed;bottom:10px;left:10px;width:40px;height:40px;border-radius:50%;background:var(--bg2);border:1px solid var(--border);color:var(--text);font-size:1.2rem;cursor:pointer;z-index:100}.mods-btn{position:fixed;bottom:10px;right:10px;padding:8px 14px;background:var(--purple);color:#fff;border:none;border-radius:16px;font-size:.75rem;font-weight:600;cursor:pointer;z-index:100}.relics-btn{position:fixed;bottom:10px;right:90px;padding:8px 14px;background:var(--gold);color:#000;border:none;border-radius:16px;font-size:.75rem;font-weight:600;cursor:pointer;z-index:100}.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;z-index:1000;padding:12px}.modal{background:var(--bg2);border-radius:14px;padding:16px;max-width:360px;width:100%;max-height:85vh;overflow-y:auto}.modal h3{font-size:1.1rem;margin-bottom:12px;text-align:center}.mod-list{display:flex;flex-direction:column;gap:6px;max-height:260px;overflow-y:auto}.mod-item{background:var(--bg3);border-radius:6px;padding:8px;border-left:3px solid var(--blue)}.mod-item.off{opacity:.4}.mod-name{font-weight:600;font-size:.8rem}.mod-desc{font-size:.65rem;color:var(--text2)}.deck-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;width:100%;max-width:320px;margin:12px 0}.deck-card{background:var(--bg2);border:2px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;text-align:center;position:relative}.deck-card.sel{border-color:var(--gold);box-shadow:0 0 12px rgba(251,191,36,.25)}.deck-card.lock{opacity:.5;cursor:not-allowed}.deck-card .name{font-size:.85rem;font-weight:700}.deck-card .desc{font-size:.6rem;color:var(--text2)}.deck-card .ability{font-size:.55rem;color:var(--cyan);margin-top:2px}.deck-card .badge{position:absolute;top:-5px;right:-5px;width:18px;height:18px;border-radius:50%;font-size:.55rem;font-weight:700;color:#fff;display:flex;align-items:center;justify-content:center}.asc-1{border-color:var(--gold)}.bg-1{background:var(--gold)}.asc-2{border-color:var(--orange)}.bg-2{background:var(--orange)}.asc-3{border-color:var(--red)}.bg-3{background:var(--red)}.asc-4{border-color:var(--pink)}.bg-4{background:var(--pink)}.asc-5{border-color:var(--purple)}.bg-5{background:var(--purple)}.asc-6{border-color:var(--cyan)}.bg-6{background:var(--cyan)}.asc-7{border-color:#fff}.bg-7{background:#fff;color:#000}.asc-grid{display:flex;flex-direction:column;gap:6px;width:100%;max-width:280px}.asc-item{background:var(--bg2);border:2px solid var(--border);border-radius:10px;padding:10px;cursor:pointer}.asc-item.sel{border-color:var(--gold);background:linear-gradient(135deg,var(--purple),#581c87)}.asc-item.lock{opacity:.4;cursor:not-allowed}.boss-box{background:linear-gradient(135deg,#7f1d1d,#450a0a);border:2px solid var(--red);border-radius:10px;padding:8px;margin-bottom:6px;text-align:center}.boss-box .name{color:#fca5a5;font-size:.9rem;font-weight:700}.boss-box .desc{font-size:.65rem;color:#fecaca}.result-box{background:var(--bg3);border-radius:10px;padding:14px;margin:14px 0}.result-row{display:flex;justify-content:space-between;padding:4px 0;font-size:.85rem}.result-row.total{border-top:1px solid var(--border);margin-top:6px;padding-top:10px;font-weight:700}.mod-choices{display:flex;flex-direction:column;gap:8px;width:100%;max-width:300px}.mod-choice{background:var(--bg2);border-radius:10px;padding:12px;cursor:pointer;border-left:4px solid var(--blue)}.mod-choice .cat{font-size:.6rem;color:var(--text2);text-transform:uppercase}.mod-choice .name{font-size:.95rem;font-weight:700;margin:3px 0}.mod-choice .desc{font-size:.75rem;color:var(--text2)}.cat-value{border-color:#4a9eff!important}.cat-suit{border-color:#9c27b0!important}.cat-threshold{border-color:#ff9800!important}.cat-action{border-color:#4caf50!important}.cat-hand{border-color:#00bcd4!important}.cat-entropy{border-color:#f44336!important}.cat-synergy{border-color:var(--pink)!important}.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;width:100%;max-width:300px;margin:14px 0}.stat-card{background:var(--bg2);border-radius:10px;padding:12px;text-align:center}.stat-card .val{font-size:1.4rem;font-weight:700}.stat-card .lbl{font-size:.6rem;color:var(--text2);text-transform:uppercase}.slider-wrap{display:flex;align-items:center;gap:10px}.slider{flex:1;-webkit-appearance:none;height:5px;border-radius:3px;background:var(--bg3)}.slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--blue);cursor:pointer}.tooltip{position:fixed;background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;max-width:240px;z-index:2000;box-shadow:0 4px 12px rgba(0,0,0,.5)}.tooltip .tt-name{font-weight:700;font-size:.85rem;margin-bottom:4px}.tooltip .tt-desc{font-size:.75rem;color:var(--text2);line-height:1.4}.rules-content{text-align:left;max-width:320px;line-height:1.5;max-height:60vh;overflow-y:auto}.rules-content h4{color:var(--gold);margin:12px 0 6px;font-size:.9rem}.rules-content p,.rules-content li{font-size:.75rem;color:var(--text2);margin-bottom:6px}.streak-ind{background:linear-gradient(135deg,var(--orange),var(--red));color:#fff;padding:3px 8px;border-radius:10px;font-size:.7rem;font-weight:700}.daily-badge{background:linear-gradient(135deg,var(--cyan),var(--blue));color:#fff;padding:4px 10px;border-radius:12px;font-size:.7rem;font-weight:600}.tab-bar{display:flex;gap:4px;margin-bottom:12px}.tab-btn{flex:1;padding:8px;background:var(--bg3);border:none;color:var(--text2);border-radius:6px;cursor:pointer;font-size:.7rem;font-weight:600}.tab-btn.active{background:var(--blue);color:#fff}.collection-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}.coll-item{background:var(--bg3);border-radius:6px;padding:8px;font-size:.7rem;border-left:3px solid var(--blue)}.coll-item.unseen{opacity:.3;border-left-color:var(--border)}.shop-wrap{display:flex;flex-direction:column;gap:8px;width:100%;max-width:320px}.shop-item{background:var(--bg3);border-radius:8px;padding:10px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;border:2px solid transparent}.shop-item:hover{border-color:var(--gold)}.shop-item.disabled{opacity:.4;cursor:not-allowed}.shop-item .s-name{font-weight:600;font-size:.8rem}.shop-item .s-desc{font-size:.6rem;color:var(--text2)}.shop-item .s-cost{font-size:.9rem;font-weight:700;color:var(--gold)}.upgrade-pick{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin:12px 0}.upgrade-card-pick{width:50px;height:70px;border-radius:5px;background:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;border:2px solid var(--border);font-weight:700;font-size:.8rem}.upgrade-card-pick:hover{border-color:var(--gold)}.upgrade-card-pick.red{color:#dc2626}.upgrade-card-pick.black{color:#1f2937}.relic{background:linear-gradient(135deg,var(--gold),var(--orange));border-radius:8px;padding:10px;margin:4px 0}.relic .r-name{font-weight:700;font-size:.85rem;color:#000}.relic .r-desc{font-size:.65rem;color:#333}.relic.locked{background:var(--bg3);opacity:.5}.relic.locked .r-name,.relic.locked .r-desc{color:var(--text2)}.achieve{background:var(--bg3);border-radius:8px;padding:10px;margin:4px 0;border-left:3px solid var(--gold)}.achieve.locked{border-left-color:var(--bg3);opacity:.5}.achieve .a-name{font-weight:700;font-size:.8rem}.achieve .a-desc{font-size:.65rem;color:var(--text2)}.achieve .a-prog{font-size:.6rem;color:var(--gold);margin-top:4px}.challenge{background:var(--bg3);border-radius:8px;padding:12px;margin:6px 0;cursor:pointer;border:2px solid var(--border)}.challenge:hover{border-color:var(--purple)}.challenge.done{border-color:var(--green);opacity:.7}.challenge .ch-name{font-weight:700;font-size:.9rem;color:var(--purple)}.challenge .ch-desc{font-size:.7rem;color:var(--text2);margin:4px 0}.challenge .ch-reward{font-size:.65rem;color:var(--gold)}.coin-pop{position:fixed;pointer-events:none;z-index:3000;color:var(--gold);font-weight:700;font-size:1.2rem;animation:coinPop .8s forwards}@keyframes coinPop{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-40px)}}.unlock-banner{position:fixed;top:20%;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,var(--gold),var(--orange));color:#000;padding:16px 32px;border-radius:12px;font-weight:700;z-index:3000;animation:unlockIn .5s}@keyframes unlockIn{0%{opacity:0;transform:translateX(-50%) scale(0.5)}100%{opacity:1;transform:translateX(-50%) scale(1)}}@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}@keyframes cursedPulse{0%,100%{filter:hue-rotate(180deg) brightness(.75)}50%{filter:hue-rotate(200deg) brightness(.65)}}.card.cursed{animation:cursedPulse 2s ease-in-out infinite}.marked-box{background:var(--bg2);border:1px solid var(--border);border-radius:6px;padding:6px 8px;display:flex;flex-direction:column;gap:2px}.marked-card{background:var(--bg3);border-radius:3px;padding:2px 6px;font-size:.65rem;font-weight:600}.card.suit-echo{box-shadow:0 0 12px var(--cyan),0 0 20px var(--cyan);border:2px solid var(--cyan)}.card-mark{position:absolute;top:1px;left:1px;font-size:.6rem;text-shadow:0 0 3px #000}.spirit-btn{position:fixed;bottom:10px;right:170px;padding:8px 14px;background:linear-gradient(135deg,#9333ea,#6b21a8);color:#fff;border:none;border-radius:16px;font-size:.75rem;font-weight:600;cursor:pointer;z-index:100}.spirit-item{background:linear-gradient(135deg,#1e1b4b,#312e81);border-radius:8px;padding:10px;margin:4px 0;border-left:3px solid var(--purple)}.spirit-item .sp-name{font-weight:700;font-size:.85rem;color:#c4b5fd}.spirit-item .sp-desc{font-size:.65rem;color:#a5b4fc}.spirit-item .sp-loyalty{font-size:.6rem;color:var(--gold);margin-top:4px}</style></head><body><div id="app"></div><div id="tooltip" class="tooltip" style="display:none"></div><div id="particles"></div>
<script>
const SUITS=['hearts','diamonds','clubs','spades'],RANKS=['A','2','3','4','5','6','7','8','9','10','J','Q','K'],RV={A:11,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,10:10,J:10,Q:10,K:10},SS={hearts:'â™¥',diamonds:'â™¦',clubs:'â™£',spades:'â™ '},SC={hearts:'#dc2626',diamonds:'#dc2626',clubs:'#1f2937',spades:'#1f2937'},AC=['#6b7280','#fbbf24','#f97316','#ef4444','#ec4899','#9333ea','#06b6d4','#fff'];
const DECKS=[{id:'standard',name:'Standard',desc:'52 cards',unlock:null,ability:'No special ability'},{id:'vampire',name:'Vampire',desc:'52 cards',unlock:'standard',ability:'Discards return cursed'},{id:'gambler',name:'Gambler',desc:'52 cards',unlock:'standard',ability:'Random mod each round'},{id:'alchemist',name:'Alchemist',desc:'52 cards',unlock:'standard',ability:'Upgrades -50% cost'},{id:'phoenix',name:'Phoenix',desc:'52 cards',unlock:'vampire',ability:'Revive once per act'},{id:'merchant',name:'Merchant',desc:'52 cards',unlock:'alchemist',ability:'+3 coins/round'},{id:'wildcard',name:'Wild',desc:'52 cards',unlock:'gambler',ability:'2 cards start Wild'},{id:'glass',name:'Glass',desc:'52 cards',unlock:'phoenix',ability:'All cards Glass'},{id:'blessed',name:'Blessed',desc:'52 cards',unlock:'merchant',ability:'Start +2 upgrades'}];
const ASCS=[{l:0,n:'Normal',d:'Standard rules'},{l:1,n:'Asc 1',d:'-1 Stability'},{l:2,n:'Asc 2',d:'-1 Action'},{l:3,n:'Asc 3',d:'Target +2'},{l:4,n:'Asc 4',d:'Start cursed'},{l:5,n:'Asc 5',d:'Harder bosses'},{l:6,n:'Asc 6',d:'2 mod choices'},{l:7,n:'Asc 7',d:'All penalties'}];
const MODS=[{id:'soft_aces',n:'Soft Aces',c:'value',d:'Aces=1 or 11'},{id:'heavy_royals',n:'Heavy Royals',c:'value',d:'Faces=12'},{id:'lean_royals',n:'Lean Royals',c:'value',d:'Faces=8'},{id:'numeric_plus',n:'Numeric+',c:'value',d:'+1 to numbers'},{id:'prime_bonus',n:'Prime+',c:'value',d:'+2 to primes'},{id:'high_roller',n:'High Roller',c:'value',d:'+3 if â‰¥10'},{id:'low_roller',n:'Low Roller',c:'value',d:'+3 if â‰¤5'},{id:'dual_suit',n:'Dual Suit',c:'suit',d:'Best 2 suits'},{id:'color_merge',n:'Color Merge',c:'suit',d:'Red/Black'},{id:'wild_ace',n:'Wild Ace',c:'suit',d:'Aces any suit'},{id:'suit_echo',n:'Suit Echo',c:'suit',d:'Same suit +2/card'},{id:'raised_ceiling',n:'High Ceiling',c:'threshold',d:'Bust=34'},{id:'lowered_ceiling',n:'Low Ceiling',c:'threshold',d:'Bust=29, +5ðŸ’°'},{id:'exactitude',n:'Exactitude',c:'threshold',d:'31=2x base'},{id:'grace_window',n:'Grace',c:'threshold',d:'+2 over OK'},{id:'risk_premium',n:'Risk+',c:'threshold',d:'+8 near bust'},{id:'safety_net',n:'Safety Net',c:'threshold',d:'1st bust free'},{id:'extra_action',n:'Extra Action',c:'action',d:'+1 action'},{id:'free_first',n:'Free First',c:'action',d:'1st draw free'},{id:'momentum',n:'Momentum',c:'action',d:'Unused=+score'},{id:'second_chance',n:'2nd Chance',c:'action',d:'Save 1 miss'},{id:'boss_heal',n:'Boss Heal',c:'action',d:'Beat boss +1HP'},{id:'retention',n:'Retention',c:'hand',d:'Keep best card'},{id:'marked_cards',n:'Marked',c:'hand',d:'See top 3'},{id:'decay',n:'Decay',c:'entropy',d:'-1/rnd, +0.5x'},{id:'chaos_draw',n:'Chaos Draw',c:'entropy',d:'Random, +1 act'},{id:'value_amp',n:'Value Amp',c:'synergy',d:'2x VALUE mods'},{id:'suit_master',n:'Suit Master',c:'synergy',d:'+5/SUIT mod'},{id:'thresh_plus',n:'Threshold+',c:'synergy',d:'+1HP/THRESH mod'},{id:'action_econ',n:'Action Econ',c:'synergy',d:'+3 coins/ACTION mod'},{id:'collector',n:'Collector',c:'synergy',d:'+5/3 mods'},{id:'rainbow',n:'Rainbow',c:'synergy',d:'6 cats=2x score'}];
const MOD_DETAILS={soft_aces:'Automatically reduces Aces from 11â†’1 if you would bust. Essential for high-value hands.',heavy_royals:'Face cards (J/Q/K) get +2 value (10â†’12). Great for face-heavy decks.',lean_royals:'Face cards get -2 value (10â†’8). Useful when you need lower totals.',numeric_plus:'All cards 2-10 get +1 value. Consistent small boost across your deck.',prime_bonus:'Cards 2, 3, 5, 7 get +2 value. Synergizes with low-value strategies.',high_roller:'Cards with base value â‰¥10 (10, J, Q, K) get +3. Powerful with Heavy Royals.',low_roller:'Cards 2, 3, 4, 5 get +3 value. Turns weak cards into strong ones.',dual_suit:'Score counts cards from your best TWO suits combined. Much more flexible.',color_merge:'Hearts+Diamonds combine as Red, Clubs+Spades as Black. Doubles your options.',wild_ace:'All Aces count toward EVERY suit. Makes Aces incredibly versatile.',suit_echo:'If you won last round with a suit, +2 per card of that suit this round.',raised_ceiling:'Bust limit raised from 31 to 34. More room to build big hands.',lowered_ceiling:'Bust limit lowered to 29 - risky! But gain +5 coins on every win.',exactitude:'If your score is exactly 31, double base points. High risk, high reward.',grace_window:'Can go 2 points over bust limit without busting. Safety margin.',risk_premium:'+8 bonus if score is within 2 of bust limit. Rewards dangerous play.',safety_net:'First time you bust each act, it gets cancelled. One free mistake.',extra_action:'Start each round with 1 extra action. More draws = more options.',free_first:'First deck draw each round costs 0 actions. Guaranteed extra card.',momentum:'Each unused action adds +1 to your hand score. Rewards efficiency.',second_chance:'Once per act, if you miss target but dont bust, count as success.',boss_heal:'Gain 1 HP when you defeat a boss (round 6). Great for sustain.',retention:'After each round, your highest-value card stays in hand. Snowball effect.',marked_cards:'Shows the top 3 cards of your deck during play. Plan your draws.',decay:'All cards lose 1 value each round (round 3 = -3). But +0.5x score multiplier.',chaos_draw:'Draws from deck are random instead of top card. But get +1 free draw per round.',value_amp:'All VALUE category mod bonuses are DOUBLED. Core of value builds.',suit_master:'SUIT mods give +5 each at knock. Without this mod, suit mods have no bonus.',thresh_plus:'Gain +1 max HP when picking each THRESHOLD mod. Build tankiness.',action_econ:'ACTION mods give +6 coins instead of +3. Double economy.',collector:'Get +5 at knock per 3 total mods. Also gives +5 per ENTROPY mod.',rainbow:'If you have mods from 6+ categories, DOUBLE your final score!'};
const RELICS=[{id:'midas',n:'The Midas',d:'Gilded cards +5 instead of +3'},{id:'suit_collect',n:'Suit Collector',d:'+10 pts per unique suit'},{id:'gamblers_coin',n:'Gamblers Coin',d:'50% chance double coins'},{id:'glass_cannon',n:'Glass Cannon',d:'Glass cards dont break, -1 HP'},{id:'echo_chamber',n:'Echo Chamber',d:'Synergy mods trigger twice'},{id:'void_start',n:'The Void',d:'Start 0 cards, +2 actions'},{id:'golden_touch',n:'Golden Touch',d:'+1 coin per card when knock'},{id:'phoenix_feather',n:'Phoenix Feather',d:'Revive with 2HP once'},{id:'lucky_7',n:'Lucky Seven',d:'7s worth 17 points'},{id:'ace_high',n:'Ace High',d:'Aces worth 15'},{id:'combo_king',n:'Combo King',d:'+2 pts per modifier'},{id:'streak_master',n:'Streak Master',d:'Streak mult caps at 5x'}];
const BOSS=[{id:'lock',n:'The Lock',a:1,d:'First draw locks suit',r:['locked_suit'],f:'No escape.'},{id:'split',n:'The Split',a:1,d:'Red vs Black only',r:['color_lock'],f:'Divided.'},{id:'void',n:'The Void',a:1,d:'Bust=limit-overflow',r:['overdraw'],f:'Greed.'},{id:'mirror',n:'The Mirror',a:1,d:'Deck/discard swap',r:['mirror_deck'],f:'Reversed.'},{id:'thief',n:'The Thief',a:1,d:'1st mod disabled',r:['disable_mod'],f:'Mine now.'},{id:'flood',n:'The Flood',a:1,d:'Start with 4 cards',r:['extra_start'],f:'Overflow.'},{id:'crown',n:'The Crown',a:2,d:'Only faces count',r:['face_only'],f:'Royalty.'},{id:'spiral',n:'The Spiral',a:2,d:'Target +1/draw',r:['spiral'],f:'Rising.'},{id:'taxman',n:'The Taxman',a:2,d:'-1 per card',r:['card_tax'],f:'Nothing free.'},{id:'scales',n:'The Scales',a:2,d:'EXACT only',r:['exact'],f:'Balance.'},{id:'hunger',n:'The Hunger',a:2,d:'-1 per action',r:['action_tax'],f:'Costly.'},{id:'floor',n:'The Floor',a:2,d:'Auto-discard low',r:['auto_discard'],f:'Culled.'},{id:'echo',n:'The Echo',a:3,d:'All prev bosses',r:['echo'],f:'Again.'},{id:'fog',n:'The Fog',a:3,d:'Hand hidden',r:['hidden'],f:'Blind.'},{id:'seal',n:'The Seal',a:3,d:'Use all actions',r:['no_early_knock'],f:'Wait.'},{id:'collapse',n:'The Collapse',a:3,d:'-2 per mod',r:['mod_penalty'],f:'Price.'},{id:'exec',n:'Executioner',a:3,d:'Fail=-2 HP',r:['double_loss'],f:'No mercy.'},{id:'paradox',n:'Paradox',a:3,d:'Values inverted',r:['invert'],f:'Twisted.'}];
const SHOP=[{id:'heal',n:'Heal',d:'+1 Stability',cost:15,type:'heal'},{id:'gilded',n:'Gilded',d:'Card +3 value',cost:18,type:'upgrade',up:'gilded'},{id:'wild',n:'Wild',d:'Card any suit',cost:22,type:'upgrade',up:'wild'},{id:'glass',n:'Glass',d:'Card 2x (breaks)',cost:10,type:'upgrade',up:'glass'},{id:'mult',n:'Mult',d:'Card 2x scoring',cost:14,type:'upgrade',up:'mult'},{id:'purify',n:'Purify',d:'Remove ALL curses',cost:30,type:'purify'},{id:'remove',n:'Remove',d:'Delete card',cost:12,type:'remove'},{id:'randmod',n:'Random Mod',d:'Gain modifier',cost:35,type:'randmod'}];
const ACHIEVES=[{id:'ach_win',n:'Winner',d:'Win a run',prog:'wins',need:1},{id:'ach_win5',n:'Veteran',d:'Win 5 runs',prog:'wins',need:5,reward:'midas'},{id:'ach_coins',n:'Rich',d:'Earn 500 coins',prog:'coins',need:500,reward:'golden_touch'},{id:'ach_streak',n:'On Fire',d:'10 streak',prog:'maxStrk',need:10,reward:'streak_master'},{id:'ach_mods',n:'Collector',d:'10 mods in run',prog:'maxMods',need:10,reward:'combo_king'},{id:'ach_glass',n:'Fragile',d:'Win Glass deck',prog:'glassWin',need:1,reward:'glass_cannon'},{id:'ach_synergy',n:'Synergist',d:'4 synergy mods',prog:'maxSyn',need:4,reward:'echo_chamber'},{id:'ach_phoenix',n:'Reborn',d:'Revive 3 times',prog:'revives',need:3,reward:'phoenix_feather'},{id:'ach_boss',n:'Boss Slayer',d:'Beat 50 bosses',prog:'boss',need:50}];
const CHALLENGES=[{id:'ch_poverty',n:'Poverty',d:'0 coins, shops 2x',mods:{startCoins:0,shopMult:2},reward:'gamblers_coin'},{id:'ch_fragile',n:'Fragile',d:'2 HP, +50% coins',mods:{maxHP:2,coinMult:1.5},reward:'suit_collect'},{id:'ch_chaos',n:'Chaos',d:'Random boss/round',mods:{chaosMode:true}},{id:'ch_minimal',n:'Minimalist',d:'Max 3 mods',mods:{maxMods:3}},{id:'ch_mono',n:'Mono',d:'Only hearts',mods:{oneSuit:'hearts'}},{id:'ch_cursed',n:'Cursed',d:'All cards cursed',mods:{allCursed:true}},{id:'ch_blind',n:'Blind',d:'Cards hidden',mods:{alwaysHidden:true}}];
const MARKS=[{id:'flame',sym:'ðŸ”¥',n:'Flame',d:'+5 value, destroyed after 3 uses',spread:true,col:'#f97316'},{id:'ice',sym:'â„ï¸',n:'Ice',d:'Cannot be discarded, +3 value',spread:false,col:'#06b6d4'},{id:'chain',sym:'â›“ï¸',n:'Chain',d:'Links to adjacent card - same suit',spread:true,col:'#6b7280'},{id:'crown',sym:'ðŸ‘‘',n:'Crown',d:'2x value but counts as 2 cards',spread:false,col:'#fbbf24'},{id:'shadow',sym:'ðŸ‘¤',n:'Shadow',d:'Hidden value until knock',spread:true,col:'#374151'},{id:'echo',sym:'ðŸ”Š',n:'Echo',d:'Triggers twice in scoring',spread:false,col:'#9333ea'},{id:'debt',sym:'ðŸ’€',n:'Debt',d:'+8 value but costs $3 when played',spread:true,col:'#ef4444'}];
const SPIRITS=[{id:'countess',n:'The Countess',d:'+2 per face card',loyalty:'Faces count as any suit',abandon:'No faces for 3 rounds',pref:'face',sym:'ðŸ‘¸'},{id:'miner',n:'The Miner',d:'+$3 when you hit exactly',loyalty:'Exact hits give double coins',abandon:'Go over target 3 times',pref:'exact',sym:'â›ï¸'},{id:'coward',n:'The Coward',d:'+1 HP when knock under 25',loyalty:'Can knock at any score',abandon:'Bust twice',pref:'safe',sym:'ðŸ€'},{id:'twins',n:'The Twins',d:'Pairs in hand +4 each',loyalty:'Triples give +15',abandon:'No pairs for 4 rounds',pref:'pairs',sym:'ðŸ‘¯'},{id:'drunk',n:'The Drunk',d:'Random card +5 each round',loyalty:'Two random cards +5',abandon:'Discard the blessed card',pref:'random',sym:'ðŸº'},{id:'veteran',n:'The Veteran',d:'+3 per boss beaten this run',loyalty:'Boss rewards doubled',abandon:'Lose to a boss',pref:'boss',sym:'ðŸŽ–ï¸'},{id:'phantom',n:'The Phantom',d:'Cursed cards worth +5 not negative',loyalty:'Curses worth +8',abandon:'Purify curses',pref:'curse',sym:'ðŸ‘»'},{id:'child',n:'The Child',d:'Low cards (2-5) worth +3',loyalty:'Low cards worth +5',abandon:'Remove a low card',pref:'low',sym:'ðŸ§’'}];
let audioCtx=null,rng=Math.random;
let S={scr:'menu',dk:null,asc:0,maxA:0,dkW:{},stab:4,maxS:4,acts:5,apr:5,score:0,mult:1,strk:0,act:1,rnd:1,tgt:17,bust:31,coins:0,deck:[],hand:[],disc:[],sel:new Set(),mods:[],modC:[],boss:null,bR:[],pBR:[],disM:null,relics:[],usedD:false,usedF:false,usedSN:false,used2:false,usedPh:false,usedRevive:false,lockS:null,lockC:null,lastS:null,lastC:null,rCtr:0,res:null,showS:false,showM:false,showR:false,showB:false,showD:false,showH:false,showSp:false,sVol:50,isDaily:false,isEndless:false,dailySeed:0,dailyPlayed:0,dailyBest:0,endlessBest:0,seenBoss:[],seenMods:[],unlockedRelics:['midas','suit_collect','gamblers_coin'],achProg:{wins:0,coins:0,maxStrk:0,maxMods:0,glassWin:0,maxSyn:0,revives:0,boss:0},achDone:[],chalDone:[],curChal:null,stats:{runs:0,wins:0,loss:0,best:0,boss:0,perf:0,rnds:0,cards:0,coins:0,maxStrk:0},actUsed:0,collTab:0,vampDisc:[],gamblerMod:null,pickUpgrade:null,pickAction:null,pickMark:null,shopItems:[],drawCount:0,tookDamage:false,runSeed:0,inputSeed:null,bossesBeaten:[],runStats:{highHand:0,totalCoins:0,modsCollected:0,roundsWon:0,roundsLost:0,bossesBeaten:0},runHistory:[],spirits:[],spiritLoyalty:{},spiritFails:{},drunkCard:null,spiritChoice:[],seenSpirits:[]};
function initAudio(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();if(audioCtx.state==='suspended')audioCtx.resume();}
function playSound(t){if(S.sVol===0||!audioCtx)return;try{const vol=S.sVol/100*.3,now=audioCtx.currentTime;const mk=()=>{const o=audioCtx.createOscillator(),g=audioCtx.createGain();o.connect(g);g.connect(audioCtx.destination);return{o,g}};if(t==='draw'){const{o,g}=mk();o.frequency.setValueAtTime(440,now);o.frequency.exponentialRampToValueAtTime(660,now+.05);g.gain.setValueAtTime(vol,now);g.gain.exponentialRampToValueAtTime(.01,now+.1);o.start(now);o.stop(now+.1);}else if(t==='success'){const{o,g}=mk();o.frequency.setValueAtTime(523,now);o.frequency.setValueAtTime(659,now+.1);o.frequency.setValueAtTime(784,now+.2);g.gain.setValueAtTime(vol,now);g.gain.exponentialRampToValueAtTime(.01,now+.35);o.start(now);o.stop(now+.35);}else if(t==='bust'){const{o,g}=mk();o.type='sawtooth';o.frequency.setValueAtTime(200,now);o.frequency.exponentialRampToValueAtTime(80,now+.3);g.gain.setValueAtTime(vol,now);g.gain.exponentialRampToValueAtTime(.01,now+.3);o.start(now);o.stop(now+.3);}else if(t==='coin'){const{o,g}=mk();o.frequency.setValueAtTime(880,now);o.frequency.setValueAtTime(1320,now+.05);g.gain.setValueAtTime(vol*.6,now);g.gain.exponentialRampToValueAtTime(.01,now+.15);o.start(now);o.stop(now+.15);}else if(t==='boss'){const{o,g}=mk();o.type='sawtooth';o.frequency.setValueAtTime(110,now);o.frequency.setValueAtTime(140,now+.2);g.gain.setValueAtTime(vol,now);g.gain.exponentialRampToValueAtTime(.01,now+.5);o.start(now);o.stop(now+.5);}else if(t==='win'){[523,659,784,1047].forEach((f,i)=>{const{o,g}=mk();o.frequency.setValueAtTime(f,now+i*.1);g.gain.setValueAtTime(vol,now+i*.1);g.gain.exponentialRampToValueAtTime(.01,now+i*.1+.2);o.start(now+i*.1);o.stop(now+i*.1+.2);});}else if(t==='unlock'){const{o,g}=mk();o.type='triangle';o.frequency.setValueAtTime(600,now);o.frequency.setValueAtTime(800,now+.1);o.frequency.setValueAtTime(1000,now+.2);g.gain.setValueAtTime(vol,now);g.gain.exponentialRampToValueAtTime(.01,now+.4);o.start(now);o.stop(now+.4);}}catch(e){}}
function spawnCoins(x,y,amt){for(let i=0;i<Math.min(amt,8);i++)setTimeout(()=>{const p=document.createElement('div');p.className='coin-pop';p.textContent='ðŸ’°';p.style.left=(x+Math.random()*40-20)+'px';p.style.top=y+'px';document.getElementById('particles').appendChild(p);setTimeout(()=>p.remove(),800);},i*50);}
function showUnlock(text){const b=document.createElement('div');b.className='unlock-banner';b.textContent='ðŸŽ‰ '+text;document.body.appendChild(b);playSound('unlock');setTimeout(()=>b.remove(),2500);}
function shakeScreen(){document.body.style.animation='shake .3s';setTimeout(()=>document.body.style.animation='',300);}
function getDailySeed(){const d=new Date();return d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate();}
function seededRandom(seed){return function(){seed=(seed*9301+49297)%233280;return seed/233280;};}
function shuf(a){const r=[...a];for(let i=r.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[r[i],r[j]]=[r[j],r[i]];}return r;}
function isDeckUnlocked(dk){return !dk.unlock||S.dkW[dk.unlock]>=1;}
function hasRelic(id){return S.relics.includes(id);}
function hM(id){return S.mods.some(m=>m.id===id&&S.disM!==m.id)||(S.gamblerMod&&S.gamblerMod.id===id);}
function countCat(cat){return S.mods.filter(m=>m.c===cat&&S.disM!==m.id).length;}
function getCats(){return new Set(S.mods.filter(m=>S.disM!==m.id).map(m=>m.c)).size;}
function getAmp(){return hM('value_amp')?2:1;}
function ld(){try{const d=JSON.parse(localStorage.getItem('t31d')||'{}');S.maxA=d.maxA||0;S.dkW=d.dkW||{};S.stats=Object.assign(S.stats,d.stats||{});S.sVol=d.sVol??50;S.dailyPlayed=d.dailyPlayed||0;S.dailyBest=d.dailyBest||0;S.endlessBest=d.endlessBest||0;S.seenBoss=d.seenBoss||[];S.seenMods=d.seenMods||[];S.unlockedRelics=d.unlockedRelics||['midas','suit_collect','gamblers_coin'];S.achProg=Object.assign(S.achProg,d.achProg||{});S.achDone=d.achDone||[];S.chalDone=d.chalDone||[];S.runHistory=d.runHistory||[];}catch(e){}}
function sv(){try{localStorage.setItem('t31d',JSON.stringify({maxA:S.maxA,dkW:S.dkW,stats:S.stats,sVol:S.sVol,dailyPlayed:S.dailyPlayed,dailyBest:S.dailyBest,endlessBest:S.endlessBest,seenBoss:S.seenBoss,seenMods:S.seenMods,unlockedRelics:S.unlockedRelics,achProg:S.achProg,achDone:S.achDone,chalDone:S.chalDone,runHistory:S.runHistory}));}catch(e){}}
function svG(){try{localStorage.setItem('t31s',JSON.stringify({dk:S.dk,asc:S.asc,stab:S.stab,maxS:S.maxS,acts:S.acts,apr:S.apr,score:S.score,mult:S.mult,strk:S.strk,act:S.act,rnd:S.rnd,tgt:S.tgt,bust:S.bust,coins:S.coins,deck:S.deck,hand:S.hand,disc:S.disc,mods:S.mods,relics:S.relics,boss:S.boss,bR:S.bR,pBR:S.pBR,disM:S.disM,usedD:S.usedD,usedF:S.usedF,usedSN:S.usedSN,used2:S.used2,usedPh:S.usedPh,usedRevive:S.usedRevive,lockS:S.lockS,lockC:S.lockC,lastS:S.lastS,lastC:S.lastC,rCtr:S.rCtr,scr:S.scr,isDaily:S.isDaily,isEndless:S.isEndless,dailySeed:S.dailySeed,actUsed:S.actUsed,vampDisc:S.vampDisc,gamblerMod:S.gamblerMod,drawCount:S.drawCount,tookDamage:S.tookDamage,curChal:S.curChal,runSeed:S.runSeed,bossesBeaten:S.bossesBeaten,runStats:S.runStats,spirits:S.spirits,spiritLoyalty:S.spiritLoyalty,spiritFails:S.spiritFails,drunkCard:S.drunkCard}));}catch(e){}}
function ldG(){try{const d=JSON.parse(localStorage.getItem('t31s'));if(d){Object.assign(S,d);S.sel=new Set();S.showS=false;S.showM=false;S.showR=false;S.showD=false;S.showSp=false;if(!S.runStats)S.runStats={highHand:0,totalCoins:0,modsCollected:0,roundsWon:0,roundsLost:0,bossesBeaten:0};if(!S.spirits)S.spirits=[];if(!S.spiritLoyalty)S.spiritLoyalty={};if(!S.spiritFails)S.spiritFails={};if(S.isDaily)rng=seededRandom(S.dailySeed+S.act*100+S.rnd);return true;}}catch(e){}return false;}
function clrG(){localStorage.removeItem('t31s');}
function hasG(){try{const d=JSON.parse(localStorage.getItem('t31s'));return d&&['playing','roundend','modifier','bossintro','shop','pickcard'].includes(d.scr);}catch(e){}return false;}
function checkAch(){ACHIEVES.forEach(a=>{if(S.achDone.includes(a.id))return;if((S.achProg[a.prog]||0)>=a.need){S.achDone.push(a.id);showUnlock('Achievement: '+a.n);if(a.reward&&!S.unlockedRelics.includes(a.reward)){S.unlockedRelics.push(a.reward);showUnlock('Relic: '+RELICS.find(r=>r.id===a.reward)?.n);}sv();}});}
function saveRunHistory(won){const seedCode=(S.dk||'STD').toUpperCase().slice(0,3)+'-'+S.asc+'-'+S.runSeed;const run={date:Date.now(),seed:seedCode,deck:S.dk,asc:S.asc,score:S.score,won,act:S.act,rnd:S.rnd,mods:S.mods.length,bosses:S.runStats?.bossesBeaten||0,highHand:S.runStats?.highHand||0,isDaily:S.isDaily,isEndless:S.isEndless};S.runHistory.unshift(run);if(S.runHistory.length>10)S.runHistory.pop();sv();}function updAch(key,val,max=false){if(max)S.achProg[key]=Math.max(S.achProg[key]||0,val);else S.achProg[key]=(S.achProg[key]||0)+val;checkAch();}
function mkC(r,s){return{rank:r,suit:s,base:RV[r],id:r+s[0]+(rng()*1e6|0),cursed:false,upgrade:null,mark:null,markUses:0};}
function mkD(){let c=[];const chal=S.curChal?CHALLENGES.find(x=>x.id===S.curChal):null;const suits=chal?.mods?.oneSuit?[chal.mods.oneSuit]:SUITS;for(const s of suits)for(const r of RANKS)c.push(mkC(r,s));if(chal?.mods?.allCursed)c.forEach(x=>x.cursed=true);return shuf(c);}
function cV(c){if(!c)return 0;let v=c.base||0;const hasSpirit=id=>S.spirits.includes(id);const spiritLoyal=id=>S.spiritLoyalty[id]>=5;if(c.cursed){if(hasSpirit('phantom'))return spiritLoyal('phantom')?8:5;return -Math.abs(v);}const amp=getAmp();if(hM('heavy_royals')&&['J','Q','K'].includes(c.rank))v+=2*amp;if(hM('lean_royals')&&['J','Q','K'].includes(c.rank))v-=2*amp;if(hM('numeric_plus')&&!['A','J','Q','K'].includes(c.rank))v+=1*amp;if(hM('prime_bonus')&&[2,3,5,7].includes(c.base))v+=2*amp;if(hM('high_roller')&&c.base>=10)v+=3*amp;if(hM('low_roller')&&['2','3','4','5'].includes(c.rank))v+=3*amp;if(hM('decay'))v=Math.max(1,v-S.rCtr);if(S.bR.includes('invert')){const iv={A:2,2:11,3:10,4:9,5:8,6:7,7:6,8:5,9:4,10:3,J:12,Q:13,K:14};v=iv[c.rank]||v;}if(c.upgrade==='gilded')v+=hasRelic('midas')?5:3;if(c.upgrade==='glass')v*=2;if(hasRelic('lucky_7')&&c.rank==='7')v=17;if(hasRelic('ace_high')&&c.rank==='A')v=15;if(hasSpirit('countess')&&['J','Q','K'].includes(c.rank))v+=2;if(hasSpirit('child')&&['2','3','4','5'].includes(c.rank))v+=spiritLoyal('child')?5:3;if(c.mark==='flame')v+=5;if(c.mark==='ice')v+=3;if(c.mark==='crown')v*=2;if(c.mark==='debt')v+=8;if(S.drunkCard===c.id)v+=spiritLoyal('drunk')?10:5;return Math.max(0,v);}
function hasMark(id){return S.hand.some(c=>c.mark===id)||S.deck.some(c=>c.mark===id);}
function getSpirit(id){return SPIRITS.find(s=>s.id===id);}
function calc(){if(!S.hand.length)return{sc:0,su:'none',co:null,cards:[],breakdown:{}};const hasSpirit=id=>S.spirits.includes(id);const spiritLoyal=id=>S.spiritLoyalty[id]>=5;const byS={};SUITS.forEach(s=>byS[s]=[]);S.hand.forEach((c,i)=>{let v=cV(c);const echoMult=c.mark==='echo'?2:1;v*=echoMult;if(c.upgrade==='wild'||hM('wild_ace')&&c.rank==='A')SUITS.forEach(s=>byS[s].push({c,v,i,w:true}));else if(c.suit&&byS[c.suit])byS[c.suit].push({c,v,i});if(spiritLoyal('countess')&&['J','Q','K'].includes(c.rank))SUITS.forEach(s=>{if(!byS[s].some(e=>e.c.id===c.id))byS[s].push({c,v,i,w:true});});});const useColor=hM('color_merge')||S.bR.includes('color_lock');function softAces(sc,cards){if(!hM('soft_aces'))return sc;let a=cards.filter(e=>e.c.rank==='A'&&e.v>1).length;while(sc>S.bust&&a>0){sc-=10;a--;}return sc;}function colorSc(col){const suits=col==='red'?['hearts','diamonds']:['clubs','spades'];const seen=new Set();let sc=0,cards=[];suits.forEach(s=>byS[s].forEach(e=>{if(!e.w||!seen.has(e.c.id)){sc+=e.v;seen.add(e.c.id);cards.push(e);}}));sc=softAces(sc,cards);if(hM('suit_echo')&&S.lastC===col)sc+=cards.length*2;return{sc,cards};}function suitSc(s){let sc=byS[s].reduce((a,e)=>a+e.v,0);sc=softAces(sc,byS[s]);if(hM('suit_echo')&&S.lastS===s)sc+=byS[s].length*2;return{sc,cards:byS[s]};}let best=0,bestS='none',bestC=null,bestCards=[];if(S.lockC){const r=colorSc(S.lockC);best=r.sc;bestS=S.lockC;bestC=S.lockC;bestCards=r.cards;}else if(S.lockS&&!useColor){const r=suitSc(S.lockS);best=r.sc;bestS=S.lockS;bestCards=r.cards;}else if(useColor){['red','black'].forEach(col=>{const r=colorSc(col);if(r.sc>best){best=r.sc;bestS=col;bestC=col;bestCards=r.cards;}});}else{for(const s of SUITS){const r=suitSc(s);if(r.sc>best){best=r.sc;bestS=s;bestCards=r.cards;}}if(hM('dual_suit'))for(let i=0;i<4;i++)for(let j=i+1;j<4;j++){const seen=new Set();let sc=0,cards=[];[...byS[SUITS[i]],...byS[SUITS[j]]].forEach(e=>{if(!e.w||!seen.has(e.c.id)){sc+=e.v;seen.add(e.c.id);cards.push(e);}});if(sc>best){best=sc;bestS=SUITS[i]+'+'+SUITS[j];bestCards=cards;}}}if(S.bR.includes('face_only')){best=0;bestCards=[];S.hand.forEach((c,i)=>{if(['J','Q','K'].includes(c.rank)){const v=cV(c);best+=v;bestCards.push({c,v,i});}});}const bd={cards:best};if(S.bR.includes('card_tax')){best-=S.hand.length;bd.cardTax=-S.hand.length;}if(S.bR.includes('mod_penalty')){best-=S.mods.length*2;bd.modPen=-S.mods.length*2;}if(hasRelic('suit_collect')){const b=new Set(S.hand.map(c=>c.suit)).size*10;best+=b;bd.suitColl=b;}let multB=0;bestCards.forEach(e=>{if(e.c.upgrade==='mult'){best+=e.v;multB+=e.v;}});if(multB)bd.mult=multB;if(hM('momentum')){best+=S.acts;bd.momentum=S.acts;}if(S.bR.includes('action_tax')){best-=S.actUsed;bd.actTax=-S.actUsed;}const suitBonus=hM('suit_master')?5:0;const collBonus=hM('collector')?5:0;const suitB=countCat('suit')*suitBonus;const entB=countCat('entropy')*(hM('collector')?5:0);const collB=Math.floor(S.mods.length/3)*collBonus;if(suitB){best+=suitB;bd.suit=suitB;}if(entB){best+=entB;bd.entropy=entB;}if(collB){best+=collB;bd.coll=collB;}if(hasRelic('combo_king')){const b=S.mods.length*2;best+=b;bd.combo=b;}if(hasRelic('echo_chamber')){best+=suitB+entB+collB;bd.echo=suitB+entB+collB;}if(hasSpirit('twins')){const ranks=S.hand.map(c=>c.rank);const pairs=ranks.filter((r,i)=>ranks.indexOf(r)!==i);if(pairs.length>0){const pairBonus=pairs.length*4;best+=pairBonus;bd.twins=pairBonus;}if(spiritLoyal('twins')){const triples=ranks.filter(r=>ranks.filter(x=>x===r).length>=3);if(triples.length>0){best+=15;bd.triples=15;}}}if(hasSpirit('veteran')){const vetBonus=S.bossesBeaten.length*3;if(vetBonus>0){best+=vetBonus;bd.veteran=vetBonus;}}bestCards.forEach(e=>{if(e.c.mark==='crown'){best+=S.hand.length;bd.crown=(bd.crown||0)+1;}});return{sc:Math.max(0,best),su:bestS,co:bestC,cards:bestCards,breakdown:bd};}
function startDaily(){const seed=getDailySeed();if(S.dailyPlayed===seed){alert('Already played!');return;}S.isDaily=true;S.isEndless=false;S.dailySeed=seed;rng=seededRandom(seed);S.dk='standard';S.asc=1;S.curChal=null;startGame();}
function startEndless(){S.isDaily=false;S.isEndless=true;rng=Math.random;S.curChal=null;startGame();}
function continueEndless(){S.isEndless=true;S.curChal=null;S.act=4;S.rnd=1;S.bR=[];S.boss=null;S.disM=null;S.usedSN=false;S.used2=false;S.usedPh=false;updT();sRnd(null);}
function startChallenge(id){S.isDaily=false;S.isEndless=false;S.curChal=id;rng=Math.random;S.dk='standard';S.asc=0;startGame();}
function startGame(){initAudio();const chal=S.curChal?CHALLENGES.find(x=>x.id===S.curChal):null;let parsedSeed=null;if(S.inputSeed){const parts=S.inputSeed.trim().split('-');if(parts.length===3){const seedNum=parseInt(parts[2]);if(!isNaN(seedNum))parsedSeed=seedNum;}}S.runSeed=S.isDaily?S.dailySeed:(parsedSeed||Math.floor(Math.random()*1000000));rng=seededRandom(S.runSeed);let st=chal?.mods?.maxHP||4,ac=5;if(S.asc>=1)st--;if(S.asc>=2)ac--;if(S.asc>=7){st--;ac--;}if(hasRelic('glass_cannon'))st--;if(hasRelic('void_start'))ac+=2;S.stab=st;S.maxS=st;S.apr=ac;S.acts=ac;S.score=0;S.mult=1;S.strk=0;S.act=1;S.rnd=1;S.coins=chal?.mods?.startCoins??0;S.mods=[];S.relics=[];S.boss=null;S.bR=[];S.pBR=[];S.disM=null;S.rCtr=0;S.lockS=null;S.lockC=null;S.lastS=null;S.lastC=null;S.usedSN=false;S.used2=false;S.usedF=false;S.usedPh=false;S.usedRevive=false;S.sel=new Set();S.deck=mkD();S.disc=[];S.hand=[];S.actUsed=0;S.vampDisc=[];S.gamblerMod=null;S.drawCount=0;S.tookDamage=false;S.inputSeed=null;S.bossesBeaten=[];S.runStats={highHand:0,totalCoins:0,modsCollected:0,roundsWon:0,roundsLost:0,bossesBeaten:0};S.spirits=[];S.spiritLoyalty={};S.spiritFails={};S.drunkCard=null;if(S.dk==='blessed'){const ups=['gilded','wild','glass','mult'];for(let i=0;i<2;i++){const idx=Math.floor(rng()*S.deck.length);S.deck[idx].upgrade=ups[Math.floor(rng()*ups.length)];}}if(S.dk==='glass')S.deck.forEach(c=>c.upgrade='glass');if(S.dk==='wildcard'){for(let i=0;i<2;i++){const idx=Math.floor(rng()*S.deck.length);S.deck[idx].upgrade='wild';}}let startCards=hasRelic('void_start')?0:1;for(let i=0;i<startCards&&S.deck.length;i++)S.hand.push(S.deck.pop());if(S.asc>=4){S.hand.forEach(c=>c.cursed=true);for(let i=0;i<5&&i<S.deck.length;i++)S.deck[i].cursed=true;}S.stats.runs++;updT();S.scr='playing';sv();svG();R();}
function start(){S.isDaily=false;S.isEndless=false;S.curChal=null;rng=Math.random;startGame();}
function updT(){if(S.isEndless){S.tgt=Math.min(17+Math.floor((S.act-1)*3)+(S.rnd-1),30);}else{const base={1:[17,18,19,20,21],2:[22,23,24,25,26],3:[26,27,28,29,30]};const bT={1:22,2:27,3:31};S.tgt=S.rnd===6?bT[S.act]:base[S.act][Math.min(S.rnd-1,4)];}if(S.asc>=3)S.tgt+=2;let lim=31;if(hM('raised_ceiling'))lim=34;if(hM('lowered_ceiling'))lim=29;S.bust=lim;}
function sRnd(ret=null){if(S.dk==='vampire'&&S.vampDisc.length){S.vampDisc.forEach(c=>{c.cursed=true;const idx=S.disc.findIndex(d=>d.id===c.id);if(idx>=0)S.disc[idx]=c;});S.vampDisc=[];}if(!S.bR.includes('mirror_deck')){S.deck=shuf([...S.deck,...S.disc]);S.disc=[];}S.hand=ret?[ret]:[];let dr=hasRelic('void_start')?0:1;if(S.bR.includes('extra_start'))dr=4;dr+=countCat('hand');dr=Math.min(dr,5);for(let i=0;i<dr&&S.deck.length&&S.hand.length<5;i++)S.hand.push(S.deck.pop());S.acts=S.apr+(hM('extra_action')?1:0)+(hM('chaos_draw')?1:0);S.usedD=false;S.usedF=false;S.sel=new Set();S.rCtr++;S.lockS=null;S.lockC=null;S.actUsed=0;if(S.dk==='gambler'){const av=MODS.filter(m=>!S.mods.some(x=>x.id===m.id));S.gamblerMod=av.length?av[Math.floor(rng()*av.length)]:null;}else S.gamblerMod=null;if(S.spirits.includes('drunk')&&S.hand.length>0){const randIdx=Math.floor(rng()*S.hand.length);S.drunkCard=S.hand[randIdx].id;}else S.drunkCard=null;updT();S.scr='playing';svG();R();}
function draw(fd=false){if(S.hand.length>=5)return;initAudio();if(fd){if(S.usedD||!S.disc.length)return;S.hand.push(S.disc.pop());S.usedD=true;S.stats.cards++;S.drawCount++;playSound('draw');}else{if(!S.deck.length){if(!S.disc.length)return;S.deck=shuf([...S.disc]);S.disc=[];}const free=hM('free_first')&&!S.usedF;if(!free&&S.acts<=0)return;let idx=S.deck.length-1;if(hM('chaos_draw'))idx=Math.floor(rng()*S.deck.length);const c=S.deck.splice(idx,1)[0];S.hand.push(c);S.stats.cards++;S.drawCount++;playSound('draw');if(free)S.usedF=true;else{S.acts--;S.actUsed++;}if(!S.lockS&&!S.lockC&&S.bR.includes('locked_suit')&&c.suit){if(hM('color_merge'))S.lockC=(c.suit==='hearts'||c.suit==='diamonds')?'red':'black';else S.lockS=c.suit;}if(S.bR.includes('spiral'))S.tgt++;if(S.bR.includes('auto_discard')&&S.hand.length>1){let mi=0;S.hand.forEach((x,i)=>{if(cV(x)<cV(S.hand[mi]))mi=i;});S.disc.push(S.hand.splice(mi,1)[0]);}}svG();R();}
function discS(){if(!S.sel.size)return;const idx=[...S.sel].sort((a,b)=>b-a);for(const i of idx){const c=S.hand[i];if(c.mark==='ice'){showUnlock('â„ï¸ Ice cards cannot be discarded!');continue;}if(S.drunkCard===c.id&&S.spirits.includes('drunk')){S.spiritFails.drunk=(S.spiritFails.drunk||0)+1;if(S.spiritFails.drunk>=1){S.spirits=S.spirits.filter(s=>s!=='drunk');showUnlock('ðŸº The Drunk has abandoned you!');}}S.hand.splice(i,1);S.disc.push(c);if(S.dk==='vampire')S.vampDisc.push({...c,cursed:false});}S.sel=new Set();svG();R();}
function knock(){const chal=S.curChal?CHALLENGES.find(x=>x.id===S.curChal):null;if(chal?.mods?.alwaysHidden&&!S.bR.includes('hidden'))S.bR.push('hidden');if(S.bR.includes('no_early_knock')&&S.acts>0)return;const hasSpirit=id=>S.spirits.includes(id);const spiritLoyal=id=>S.spiritLoyalty[id]>=5;initAudio();const{sc,breakdown:bd}=calc();let fs=sc;let effL=S.bust+(hM('grace_window')?2:0);let bust=fs>effL;if(bust&&S.bR.includes('overdraw')){fs=S.bust-(fs-S.bust);bust=false;}if(bust&&hM('safety_net')&&!S.usedSN){bust=false;S.usedSN=true;}let ok=S.bR.includes('exact')?(!bust&&fs===S.tgt):(!bust&&fs>=S.tgt);if(hasSpirit('coward')&&spiritLoyal('coward')&&!bust)ok=true;let saved=false;if(!ok&&!bust&&hM('second_chance')&&!S.used2){ok=true;saved=true;S.used2=true;S.mods=S.mods.filter(m=>m.id!=='second_chance');}if(hM('rainbow')&&getCats()>=6){fs*=2;bd.rainbow=fs/2;}let base=0,bonus=0,coinGain=0,ov=0;S.stats.rnds++;if(ok){setTimeout(()=>playSound('success'),150);base=10;ov=fs-S.tgt;if(ov>=5)bonus+=10;else if(ov>=2)bonus+=5;if(S.rnd===6)bonus+=15;if(S.isEndless)bonus+=S.act*2;if(hM('exactitude')&&fs===31)bonus+=base;if(hM('risk_premium')&&fs>=S.bust-2)bonus+=8;S.strk++;updAch('maxStrk',S.strk,true);S.mult=Math.min(1+(S.strk-1)*.5+(hM('decay')?.5:0),hasRelic('streak_master')?5:3.5);const rs=Math.floor((base+bonus)*S.mult);S.score+=rs;if(S.rnd===6){S.stats.boss++;updAch('boss',1);if(S.boss)S.bossesBeaten.push({n:S.boss.n,a:S.act});if(hM('boss_heal'))S.stab=Math.min(S.maxS,S.stab+1);}const actBonus=hM('action_econ')?6:3;coinGain=5+(fs===S.tgt?5:0)+(S.strk>=3?3:0)+(ov>=5?5:0)+countCat('action')*actBonus;if(hM('lowered_ceiling'))coinGain+=5;if(S.dk==='merchant')coinGain+=3;if(hasRelic('golden_touch'))coinGain+=S.hand.length;if(hasRelic('gamblers_coin')&&rng()>.5)coinGain*=2;if(chal?.mods?.coinMult)coinGain=Math.floor(coinGain*chal.mods.coinMult);if(hasSpirit('miner')&&fs===S.tgt){coinGain+=spiritLoyal('miner')?6:3;S.spiritLoyalty.miner=(S.spiritLoyalty.miner||0)+1;}if(hasSpirit('coward')&&fs<25){S.stab=Math.min(S.maxS,S.stab+1);S.spiritLoyalty.coward=(S.spiritLoyalty.coward||0)+1;}if(hasSpirit('countess')&&S.hand.some(c=>['J','Q','K'].includes(c.rank)))S.spiritLoyalty.countess=(S.spiritLoyalty.countess||0)+1;if(hasSpirit('child')&&S.hand.some(c=>['2','3','4','5'].includes(c.rank)))S.spiritLoyalty.child=(S.spiritLoyalty.child||0)+1;if(hasSpirit('drunk')&&S.hand.some(c=>c.id===S.drunkCard))S.spiritLoyalty.drunk=(S.spiritLoyalty.drunk||0)+1;if(hasSpirit('twins')){const ranks=S.hand.map(c=>c.rank);if(ranks.some((r,i)=>ranks.indexOf(r)!==i))S.spiritLoyalty.twins=(S.spiritLoyalty.twins||0)+1;else{S.spiritFails.twins=(S.spiritFails.twins||0)+1;if(S.spiritFails.twins>=4){S.spirits=S.spirits.filter(s=>s!=='twins');showUnlock('ðŸ‘¯ The Twins have abandoned you!');}}}S.hand.forEach(c=>{if(c.mark==='debt'){S.coins=Math.max(0,S.coins-3);if(S.coins<3){c.mark=null;showUnlock('ðŸ’€ Debt spread! Card unmarked.');}}if(c.mark==='flame'){c.markUses=(c.markUses||0)+1;if(c.markUses>=3){c.mark=null;showUnlock('ðŸ”¥ Flame burned out!');}}});S.coins+=coinGain;S.stats.coins+=coinGain;S.runStats.totalCoins+=coinGain;S.runStats.roundsWon++;if(fs>S.runStats.highHand)S.runStats.highHand=fs;if(S.rnd===6)S.runStats.bossesBeaten++;updAch('coins',coinGain);playSound('coin');spawnCoins(window.innerWidth/2,window.innerHeight/2,coinGain);S.res={sc:fs,ok:true,bust:false,base,bonus,rs,mult:S.mult,saved,coinGain,bd};}else{setTimeout(()=>{playSound('bust');shakeScreen();},100);S.strk=0;S.mult=1;S.tookDamage=true;if(hasSpirit('coward')){S.spiritFails.coward=(S.spiritFails.coward||0)+1;if(S.spiritFails.coward>=2){S.spirits=S.spirits.filter(s=>s!=='coward');showUnlock('ðŸ€ The Coward has fled!');}}if(hasSpirit('miner')&&fs>S.tgt){S.spiritFails.miner=(S.spiritFails.miner||0)+1;if(S.spiritFails.miner>=3){S.spirits=S.spirits.filter(s=>s!=='miner');showUnlock('â›ï¸ The Miner has abandoned you!');}}if(hasSpirit('countess')&&!S.hand.some(c=>['J','Q','K'].includes(c.rank))){S.spiritFails.countess=(S.spiritFails.countess||0)+1;if(S.spiritFails.countess>=3){S.spirits=S.spirits.filter(s=>s!=='countess');showUnlock('ðŸ‘¸ The Countess has abandoned you!');}}if(hasSpirit('veteran')&&S.rnd===6){S.spirits=S.spirits.filter(s=>s!=='veteran');showUnlock('ðŸŽ–ï¸ The Veteran has abandoned you!');}let loss=S.bR.includes('double_loss')?2:1;if(S.stab-loss<=0&&S.dk==='phoenix'&&!S.usedPh){S.usedPh=true;S.stab=1;loss=0;updAch('revives',1);}else if(S.stab-loss<=0&&hasRelic('phoenix_feather')&&!S.usedRevive){S.usedRevive=true;S.stab=2;loss=0;updAch('revives',1);}else S.stab=Math.max(0,S.stab-loss);coinGain=2;S.coins+=coinGain;S.runStats.roundsLost++;S.res={sc:fs,ok:false,bust,base:0,bonus:0,rs:0,mult:1,coinGain,bd};}S.lastS=S.res.co?null:S.res.su;S.lastC=S.res.co;if(!hasRelic('glass_cannon'))S.hand=S.hand.filter(c=>{if(c.upgrade==='glass'){S.disc.push({...c,upgrade:null});return false;}return true;});let ret=null;if(hM('retention')&&S.hand.length){let mi=0;S.hand.forEach((c,i)=>{if(cV(c)>cV(S.hand[mi]))mi=i;});ret=S.hand.splice(mi,1)[0];}S.disc.push(...S.hand);S.hand=[];S.res.ret=ret;if(S.stab<=0){S.stats.loss++;if(S.score>S.stats.best)S.stats.best=S.score;if(S.isDaily){S.dailyPlayed=S.dailySeed;if(S.score>S.dailyBest)S.dailyBest=S.score;}if(S.isEndless&&S.score>S.endlessBest)S.endlessBest=S.score;saveRunHistory(false);sv();clrG();S.scr='gameover';}else{S.scr='roundend';svG();}R();}
function adv(){const chal=S.curChal?CHALLENGES.find(x=>x.id===S.curChal):null;const maxMods=chal?.mods?.maxMods||12;if(S.rnd!==5&&S.rnd!==6&&S.mods.length<(S.isEndless?maxMods:6)){genMods();if(S.modC.length){S.scr='modifier';svG();R();return;}}S.scr='shop';genShop();svG();R();}
function genShop(){const chal=S.curChal?CHALLENGES.find(x=>x.id===S.curChal):null;S.shopItems=shuf([...SHOP]).slice(0,5).map(i=>({...i}));if(S.dk==='merchant')S.shopItems.push({id:'bonus',n:'Lucky',d:'+10 coins',cost:0,type:'lucky'});if(rng()<0.3&&S.spirits.length<3){const avSpirits=SPIRITS.filter(sp=>!S.spirits.includes(sp.id));if(avSpirits.length){const sp=avSpirits[Math.floor(rng()*avSpirits.length)];S.shopItems.push({id:'spirit_'+sp.id,n:sp.sym+' '+sp.n,d:sp.d,cost:25,type:'spirit',spirit:sp.id});}}if(rng()<0.4){const avMarks=MARKS.filter(m=>m.id!=='shadow'&&m.id!=='chain');const mk=avMarks[Math.floor(rng()*avMarks.length)];S.shopItems.push({id:'mark_'+mk.id,n:mk.sym+' '+mk.n,d:mk.d,cost:mk.id==='echo'?30:(mk.id==='crown'?28:15),type:'mark',mark:mk.id});}if(chal?.mods?.shopMult)S.shopItems.forEach(i=>i.cost=Math.floor(i.cost*chal.mods.shopMult));if(S.dk==='alchemist')S.shopItems.filter(i=>i.type==='upgrade').forEach(i=>i.cost=Math.floor(i.cost*.5));}
function buyShop(item){if(S.coins<item.cost)return;S.coins-=item.cost;playSound('coin');const removeItem=()=>{const idx=S.shopItems.findIndex(i=>i.id===item.id);if(idx>=0)S.shopItems.splice(idx,1);};if(item.type==='heal'){S.stab=Math.min(S.maxS,S.stab+1);if(S.stab>=S.maxS)removeItem();}else if(item.type==='upgrade'){S.pickUpgrade=item.up;S.pickAction='upgrade';S.scr='pickcard';removeItem();svG();R();return;}else if(item.type==='remove'){S.pickAction='remove';S.scr='pickcard';removeItem();svG();R();return;}else if(item.type==='purify'){S.deck.forEach(c=>c.cursed=false);S.hand.forEach(c=>c.cursed=false);if(S.spirits.includes('phantom')){S.spirits=S.spirits.filter(s=>s!=='phantom');showUnlock('ðŸ‘» The Phantom has abandoned you!');}removeItem();showUnlock('Curses removed!');}else if(item.type==='randmod'){const av=MODS.filter(m=>!S.mods.some(x=>x.id===m.id));if(av.length){const m=av[Math.floor(rng()*av.length)];S.mods.push({...m});if(!S.seenMods.includes(m.id)){S.seenMods.push(m.id);sv();}updAch('maxMods',S.mods.length,true);updAch('maxSyn',countCat('synergy'),true);showUnlock('Mod: '+m.n);}removeItem();}else if(item.type==='lucky'){S.coins+=10;removeItem();showUnlock('+10 coins!');}else if(item.type==='spirit'){if(S.spirits.length>=3){showUnlock('Max 3 spirits!');S.coins+=item.cost;return;}S.spirits.push(item.spirit);S.spiritLoyalty[item.spirit]=0;S.spiritFails[item.spirit]=0;if(!S.seenSpirits)S.seenSpirits=[];if(!S.seenSpirits.includes(item.spirit))S.seenSpirits.push(item.spirit);const sp=SPIRITS.find(s=>s.id===item.spirit);showUnlock(sp.sym+' '+sp.n+' joined!');removeItem();}else if(item.type==='mark'){S.pickMark=item.mark;S.pickAction='mark';S.scr='pickcard';removeItem();svG();R();return;}svG();R();}
function applyCardAction(idx){if(idx<0||idx>=S.deck.length)return;if(S.pickAction==='upgrade'){S.deck[idx].upgrade=S.pickUpgrade;showUnlock('Card upgraded!');}else if(S.pickAction==='remove'){if(S.spirits.includes('child')&&['2','3','4','5'].includes(S.deck[idx].rank)){S.spirits=S.spirits.filter(s=>s!=='child');showUnlock('ðŸ§’ The Child has abandoned you!');}S.deck.splice(idx,1);showUnlock('Card removed!');}else if(S.pickAction==='mark'){const mk=MARKS.find(m=>m.id===S.pickMark);S.deck[idx].mark=S.pickMark;S.deck[idx].markUses=0;showUnlock(mk.sym+' Mark applied!');}S.pickUpgrade=null;S.pickMark=null;S.pickAction=null;S.scr='shop';svG();R();}
function skipShop(){proceedFromShop();}
function proceedFromShop(){const chal=S.curChal?CHALLENGES.find(x=>x.id===S.curChal):null;let nr=S.rnd+1,na=S.act;if(nr>6){nr=1;na++;S.bR=[];S.boss=null;S.disM=null;S.usedSN=false;S.used2=false;S.usedPh=false;if(!S.isEndless&&na>3){playSound('win');S.stats.wins++;updAch('wins',1);if(S.score>S.stats.best)S.stats.best=S.score;S.maxA=Math.max(S.maxA,S.asc+1);S.dkW[S.dk]=Math.max(S.dkW[S.dk]||0,S.asc+1);if(S.dk==='glass')updAch('glassWin',1);if(S.curChal&&!S.chalDone.includes(S.curChal)){S.chalDone.push(S.curChal);const ch=CHALLENGES.find(x=>x.id===S.curChal);if(ch?.reward&&!S.unlockedRelics.includes(ch.reward)){S.unlockedRelics.push(ch.reward);showUnlock('Relic: '+RELICS.find(r=>r.id===ch.reward)?.n);}}saveRunHistory(true);sv();clrG();S.scr='victory';R();return;}}S.rnd=nr;S.act=na;if(S.isDaily)rng=seededRandom(S.dailySeed+na*100+nr);const ret=S.res?.ret||null;if(nr===6||chal?.mods?.chaosMode){const actMod=S.isEndless?((na-1)%3)+1:na;const bossPool=chal?.mods?.chaosMode?BOSS:BOSS.filter(b=>S.asc>=5?b.a>=actMod:b.a===actMod);S.boss=bossPool[Math.floor(rng()*bossPool.length)];if(!S.seenBoss.includes(S.boss.id)){S.seenBoss.push(S.boss.id);sv();}S.pBR=[...S.bR];S.bR=[...S.boss.r];if(S.bR.includes('echo'))S.bR.push(...S.pBR.filter(r=>r!=='echo'));if(S.bR.includes('mirror_deck')){const t=S.deck;S.deck=shuf([...S.disc]);S.disc=[...t];}if(S.bR.includes('disable_mod')&&S.mods.length)S.disM=S.mods[0].id;S.res={...S.res,ret};playSound('boss');S.scr='bossintro';svG();R();return;}sRnd(ret);}
function genMods(){const av=MODS.filter(m=>!S.mods.some(a=>a.id===m.id));const cnt=S.asc>=6?2:3;S.modC=shuf([...av]).slice(0,cnt);}
function selM(m){S.mods.push({...m});S.runStats.modsCollected++;if(!S.seenMods.includes(m.id)){S.seenMods.push(m.id);sv();}updAch('maxMods',S.mods.length,true);updAch('maxSyn',countCat('synergy'),true);if(m.c==='threshold'&&hM('thresh_plus')){S.maxS++;S.stab++;}S.scr='shop';genShop();svG();R();}
function skipM(){S.scr='shop';genShop();svG();R();}
function togC(i){if(S.sel.has(i))S.sel.delete(i);else S.sel.add(i);R();}
function showTT(item,x,y){const tt=document.getElementById('tooltip');let name=item.n||item.name||'';let desc=item.d||item.desc||'';if(item.id&&MOD_DETAILS[item.id])desc=MOD_DETAILS[item.id];if(item.cursed){name='â˜ ï¸ CURSED';desc='This card has negative value! It subtracts from your score instead of adding. Remove curses at the shop with Purify.';}tt.innerHTML='<div class="tt-name">'+name+'</div><div class="tt-desc">'+desc+'</div>';tt.style.display='block';const r=tt.getBoundingClientRect();let left=x-r.width/2,top=y-r.height-10;if(left<10)left=10;if(left+r.width>window.innerWidth-10)left=window.innerWidth-r.width-10;if(top<10)top=y+20;tt.style.left=left+'px';tt.style.top=top+'px';}
function hideTT(){document.getElementById('tooltip').style.display='none';}
function bindHold(el,item){let timer=null,held=false;const start=e=>{held=false;timer=setTimeout(()=>{held=true;const rect=el.getBoundingClientRect();showTT(item,rect.left+rect.width/2,rect.top);},400);};const end=e=>{if(timer)clearTimeout(timer);timer=null;hideTT();if(held){e.preventDefault();e.stopPropagation();}};el.addEventListener('touchstart',start,{passive:true});el.addEventListener('touchend',end);el.addEventListener('touchcancel',end);el.addEventListener('mousedown',start);el.addEventListener('mouseup',end);el.addEventListener('mouseleave',end);}
function bindDeckHold(el){let timer=null,held=false;const start=e=>{held=false;timer=setTimeout(()=>{held=true;S.showD=true;R();},400);};const end=e=>{if(timer)clearTimeout(timer);timer=null;if(held){S.showD=false;R();e.preventDefault();e.stopPropagation();}};el.addEventListener('touchstart',start,{passive:true});el.addEventListener('touchend',end);el.addEventListener('touchcancel',end);el.addEventListener('mousedown',start);el.addEventListener('mouseup',end);el.addEventListener('mouseleave',end);}
function R(){const app=document.getElementById('app');app.innerHTML='';hideTT();if(S.scr==='menu')rMenu(app);else if(S.scr==='rules')rRules(app);else if(S.scr==='collection')rColl(app);else if(S.scr==='challenges')rChal(app);else if(S.scr==='history')rHist(app);else if(S.scr==='decksel')rDeck(app);else if(S.scr==='ascsel')rAsc(app);else if(S.scr==='stats')rStat(app);else if(S.scr==='playing')rPlay(app);else if(S.scr==='roundend')rEnd(app);else if(S.scr==='shop')rShop(app);else if(S.scr==='pickcard')rPick(app);else if(S.scr==='modifier')rMod(app);else if(S.scr==='bossintro')rBoss(app);else if(S.scr==='gameover')rOver(app);else if(S.scr==='victory')rWin(app);if(S.showS)rSet(app);if(S.showM&&S.scr==='playing')rML(app);if(S.showR&&S.scr==='playing')rRL(app);if(S.showB&&S.scr==='playing')rBL(app);if(S.showD&&S.scr==='playing')rDL(app);if(S.showSp&&S.scr==='playing')rSpL(app);}
function rMenu(app){const d=document.createElement('div');d.className='screen active';const hs=hasG(),pt=S.dailyPlayed===getDailySeed();let scores='';if(S.dailyBest||S.endlessBest)scores='<div style="font-size:.7rem;color:var(--text2);margin:4px 0">'+(S.endlessBest?'Endless: <span style="color:var(--pink)">'+S.endlessBest+'</span>':'')+(S.endlessBest&&S.dailyBest?' | ':'')+(S.dailyBest?'Daily: <span class="gold">'+S.dailyBest+'</span>':'')+'</div>';d.innerHTML='<h1 style="font-size:2.2rem;margin-bottom:20px">THIRTY-ONE</h1><div style="display:flex;flex-direction:column;gap:6px;width:100%;max-width:220px">'+(hs?'<button class="btn btn-success" onclick="ldG();R()">Continue</button>':'')+'<button class="btn btn-primary" onclick="S.dk=null;S.scr=\'decksel\';R()">New Run</button><button class="btn btn-gold" onclick="startDaily()" '+(pt?'disabled':'')+'><span class="daily-badge">ðŸ“… Daily</span></button>'+scores+'<button class="btn btn-secondary" onclick="S.scr=\'challenges\';R()">ðŸ† Challenges</button><button class="btn btn-secondary" onclick="S.scr=\'history\';R()">ðŸ“œ Run History</button><button class="btn btn-secondary" onclick="S.scr=\'stats\';R()">ðŸ“Š Stats</button><button class="btn btn-secondary" onclick="S.collTab=0;S.scr=\'collection\';R()">ðŸ“š Collection</button></div><button class="btn" style="margin-top:20px;background:linear-gradient(135deg,var(--cyan),var(--blue));color:#fff;font-size:1rem" onclick="S.scr=\'rules\';R()">ðŸ“– How to Play</button>';app.appendChild(d);}
function rRules(app){const d=document.createElement('div');d.className='screen active';d.innerHTML='<h2>ðŸ“– How to Play</h2><div class="rules-content"><h4>ðŸŽ¯ Goal</h4><p>Build a hand hitting target without busting (31+).</p><h4>ðŸƒ Scoring</h4><p>Only same-suit cards count. A=11, Face=10.</p><h4>ðŸŽ® Actions</h4><p>Draw (costs action), Discard (free), Knock (end).</p><h4>ðŸ’° Coins</h4><p>Earn from wins. Spend at shop!</p><h4>âœ¨ Upgrades</h4><p>Gilded +3, Wild any suit, Glass 2x, Mult 2x</p><h4>ðŸº Relics</h4><p>Powerful items from achievements!</p></div><button class="btn btn-secondary" style="margin-top:12px" onclick="S.scr=\'menu\';R()">Back</button>';app.appendChild(d);}
function rChal(app){const d=document.createElement('div');d.className='screen active';d.style.cssText='justify-content:flex-start;padding-top:20px';d.innerHTML='<h2>ðŸ† Challenges</h2><p style="color:var(--text2);font-size:.75rem;margin-bottom:12px">Complete for rewards</p><div style="max-height:60vh;overflow-y:auto;width:100%;max-width:320px" id="chL"></div><button class="btn btn-secondary" style="margin-top:12px" onclick="S.scr=\'menu\';R()">Back</button>';app.appendChild(d);const cl=document.getElementById('chL');CHALLENGES.forEach(ch=>{const done=S.chalDone.includes(ch.id);const c=document.createElement('div');c.className='challenge'+(done?' done':'');c.innerHTML='<div class="ch-name">'+(done?'âœ“ ':'')+ch.n+'</div><div class="ch-desc">'+ch.d+'</div>'+(ch.reward?'<div class="ch-reward">Reward: '+RELICS.find(r=>r.id===ch.reward)?.n+'</div>':'');if(!done)c.onclick=()=>startChallenge(ch.id);cl.appendChild(c);});}
function rHist(app){const d=document.createElement('div');d.className='screen active';d.style.cssText='justify-content:flex-start;padding-top:20px';let content='<h2>ðŸ“œ Run History</h2><p style="color:var(--text2);font-size:.75rem;margin-bottom:12px">Last 10 runs</p><div style="max-height:60vh;overflow-y:auto;width:100%;max-width:340px">';if(!S.runHistory||!S.runHistory.length){content+='<div style="color:var(--text2);text-align:center;padding:40px">No runs yet. Start playing!</div>';}else{S.runHistory.forEach((run,i)=>{const date=new Date(run.date);const dateStr=(date.getMonth()+1)+'/'+date.getDate();const deckName=DECKS.find(dk=>dk.id===run.deck)?.name||'Standard';const mode=run.isDaily?'ðŸ“… ':(run.isEndless?'âˆž ':'');const result=run.won?'<span style="color:var(--green)">âœ“ WIN</span>':'<span style="color:var(--red)">âœ— Act '+run.act+' R'+run.rnd+'</span>';content+='<div style="background:var(--bg2);border-radius:8px;padding:10px;margin-bottom:8px;border-left:3px solid '+(run.won?'var(--green)':'var(--red)')+'"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div style="font-weight:600;font-size:.85rem">'+mode+deckName+' A'+run.asc+'</div><div style="font-size:.65rem;color:var(--text2)">'+dateStr+'</div></div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><div style="font-size:1.1rem;font-weight:700;color:var(--gold)">'+run.score+'</div>'+result+'</div><div style="display:flex;gap:10px;font-size:.6rem;color:var(--text2)"><span>ðŸŽ¯ '+run.highHand+'</span><span>âœ¨ '+run.mods+' mods</span><span>ðŸ‘‘ '+run.bosses+' bosses</span></div><div style="font-size:.55rem;color:var(--cyan);font-family:monospace;margin-top:4px;cursor:pointer" onclick="navigator.clipboard.writeText(\''+run.seed+'\');this.textContent=\'Copied!\';setTimeout(()=>this.textContent=\''+run.seed+'\',1500)">'+run.seed+'</div></div>';});}content+='</div><button class="btn btn-secondary" style="margin-top:12px" onclick="S.scr=\'menu\';R()">Back</button>';d.innerHTML=content;app.appendChild(d);}
function rColl(app){const d=document.createElement('div');d.className='screen active';d.style.cssText='justify-content:flex-start;padding-top:20px';d.innerHTML='<h2>ðŸ“š Collection</h2><div class="tab-bar" style="width:100%;max-width:320px"><button class="tab-btn '+(S.collTab===0?'active':'')+'" onclick="S.collTab=0;R()">Bosses</button><button class="tab-btn '+(S.collTab===1?'active':'')+'" onclick="S.collTab=1;R()">Mods</button><button class="tab-btn '+(S.collTab===2?'active':'')+'" onclick="S.collTab=2;R()">Relics</button><button class="tab-btn '+(S.collTab===3?'active':'')+'" onclick="S.collTab=3;R()">Achieve</button></div><div style="width:100%;max-width:320px;max-height:50vh;overflow-y:auto" id="cL"></div><button class="btn btn-secondary" style="margin-top:12px" onclick="S.scr=\'menu\';R()">Back</button>';app.appendChild(d);const cl=document.getElementById('cL');if(S.collTab===0){cl.innerHTML='<p style="color:var(--text2);font-size:.7rem;text-align:center">'+S.seenBoss.length+'/'+BOSS.length+'</p>';[1,2,3].forEach(a=>{cl.innerHTML+='<div style="font-size:.65rem;color:var(--gold);margin:6px 0">ACT '+a+'</div>';BOSS.filter(b=>b.a===a).forEach(b=>{const seen=S.seenBoss.includes(b.id);cl.innerHTML+='<div class="coll-item'+(seen?'':' unseen')+'" style="border-color:var(--red)"><div style="font-weight:600">'+(seen?b.n:'???')+'</div><div style="font-size:.55rem;color:var(--text2)">'+(seen?b.d:'???')+'</div></div>';});});}else if(S.collTab===1){cl.innerHTML='<p style="color:var(--text2);font-size:.7rem;text-align:center">'+S.seenMods.length+'/'+MODS.length+'</p><div class="collection-grid"></div>';const g=cl.querySelector('.collection-grid');MODS.forEach(m=>{const seen=S.seenMods.includes(m.id);g.innerHTML+='<div class="coll-item cat-'+m.c+(seen?'':' unseen')+'"><div style="font-weight:600;font-size:.7rem">'+(seen?m.n:'???')+'</div><div style="font-size:.55rem;color:var(--text2)">'+(seen?m.d:'???')+'</div></div>';});}else if(S.collTab===2){cl.innerHTML='<p style="color:var(--text2);font-size:.7rem;text-align:center">'+S.unlockedRelics.length+'/'+RELICS.length+'</p>';RELICS.forEach(r=>{const ok=S.unlockedRelics.includes(r.id);cl.innerHTML+='<div class="relic'+(ok?'':' locked')+'"><div class="r-name">'+(ok?r.n:'???')+'</div><div class="r-desc">'+(ok?r.d:'Unlock via achievements')+'</div></div>';});}else{cl.innerHTML='<p style="color:var(--text2);font-size:.7rem;text-align:center">'+S.achDone.length+'/'+ACHIEVES.length+'</p>';ACHIEVES.forEach(a=>{const done=S.achDone.includes(a.id);const prog=S.achProg[a.prog]||0;cl.innerHTML+='<div class="achieve'+(done?'':' locked')+'"><div class="a-name">'+(done?'âœ“ ':'')+a.n+'</div><div class="a-desc">'+a.d+'</div>'+(done?'':'<div class="a-prog">'+Math.min(prog,a.need)+'/'+a.need+'</div>')+'</div>';});}}
function rDeck(app){const d=document.createElement('div');d.className='screen active';d.innerHTML='<h2>Choose Deck</h2><div class="deck-grid" id="dg"></div><div style="margin-top:12px;background:var(--bg2);border-radius:8px;padding:10px"><div style="font-size:.7rem;color:var(--text2);margin-bottom:6px">PASTE SEED (optional)</div><div style="display:flex;gap:6px"><input type="text" id="seedIn" placeholder="e.g. STA-0-123456" style="flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:8px;color:var(--text);font-family:monospace;font-size:.8rem"><button class="btn btn-sm btn-secondary" onclick="document.getElementById(\'seedIn\').value=\'\';S.inputSeed=null;">Clear</button></div></div><div style="display:flex;gap:6px;margin-top:12px"><button class="btn btn-secondary" id="bk">Back</button><button class="btn btn-success" id="nx">Next</button></div>';app.appendChild(d);const seedIn=document.getElementById('seedIn');if(S.inputSeed)seedIn.value=S.inputSeed;seedIn.oninput=()=>{S.inputSeed=seedIn.value;};document.getElementById('bk').onclick=()=>{S.scr='menu';R();};document.getElementById('nx').onclick=()=>{if(!S.dk){alert('Select deck');return;}S.scr='ascsel';R();};const g=document.getElementById('dg');DECKS.forEach(dk=>{const w=S.dkW[dk.id]||0,ok=isDeckUnlocked(dk);const c=document.createElement('div');c.className='deck-card'+(S.dk===dk.id?' sel':'')+(w>0?' asc-'+Math.min(w,7):'')+(!ok?' lock':'');if(ok){c.innerHTML='<div class="name">'+dk.name+'</div><div class="desc">'+dk.desc+'</div><div class="ability">'+dk.ability+'</div>'+(w?'<div class="badge bg-'+Math.min(w,7)+'">'+w+'</div>':'');c.onclick=()=>{S.dk=dk.id;R();};}else{const req=DECKS.find(x=>x.id===dk.unlock);c.innerHTML='<div style="font-size:1.2rem">ðŸ”’</div><div class="name">'+dk.name+'</div><div class="desc">Win: '+(req?.name||'')+'</div>';}g.appendChild(c);});}
function rAsc(app){const d=document.createElement('div');d.className='screen active';d.innerHTML='<h2>Ascension</h2><p style="color:var(--text2);font-size:.75rem;margin-bottom:10px">Higher = harder</p><div class="asc-grid" id="ag"></div><div style="display:flex;gap:6px;margin-top:12px"><button class="btn btn-secondary" id="bk">Back</button><button class="btn btn-success" id="st">Start</button></div>';app.appendChild(d);document.getElementById('bk').onclick=()=>{S.scr='decksel';R();};document.getElementById('st').onclick=()=>{if(!S.dk)return;start();};const g=document.getElementById('ag');ASCS.forEach(a=>{const ok=a.l<=S.maxA;const c=document.createElement('div');c.className='asc-item'+(S.asc===a.l?' sel':'')+(!ok?' lock':'');c.innerHTML='<div style="font-weight:700;color:'+AC[a.l]+'">'+a.n+'</div><div style="font-size:.7rem;color:var(--text2)">'+(ok?a.d:'ðŸ”’')+'</div>';if(ok)c.onclick=()=>{S.asc=a.l;R();};g.appendChild(c);});}
function rStat(app){const s=S.stats,wr=s.runs?Math.round(s.wins/s.runs*100):0;const d=document.createElement('div');d.className='screen active';d.innerHTML='<h2>ðŸ“Š Stats</h2><div class="stats-grid"><div class="stat-card"><div class="val">'+s.runs+'</div><div class="lbl">Runs</div></div><div class="stat-card"><div class="val green">'+s.wins+'</div><div class="lbl">Wins</div></div><div class="stat-card"><div class="val gold">'+wr+'%</div><div class="lbl">Win Rate</div></div><div class="stat-card"><div class="val" style="color:var(--blue)">'+s.best+'</div><div class="lbl">Best</div></div><div class="stat-card"><div class="val" style="color:var(--gold)">'+s.coins+'</div><div class="lbl">Coins</div></div><div class="stat-card"><div class="val" style="color:var(--orange)">'+s.boss+'</div><div class="lbl">Bosses</div></div></div><button class="btn btn-secondary" style="margin-top:12px" onclick="S.scr=\'menu\';R()">Back</button>';app.appendChild(d);}
function rPlay(app){const chal=S.curChal?CHALLENGES.find(x=>x.id===S.curChal):null;const hid=S.bR.includes('hidden')||chal?.mods?.alwaysHidden;const canD=S.hand.length<5&&(S.deck.length||S.disc.length)&&(S.acts>0||(hM('free_first')&&!S.usedF));const canDis=S.sel.size>0;const canK=S.hand.length>0&&(!S.bR.includes('no_early_knock')||S.acts<=0);const d=document.createElement('div');d.className='game-wrap';const sb=document.createElement('button');sb.className='settings-btn';sb.textContent='âš™';sb.onclick=()=>{S.showS=true;R();};d.appendChild(sb);const h=document.createElement('div');h.className='header';const mode=S.isDaily?'ðŸ“… ':(S.isEndless?'âˆž ':(S.curChal?'ðŸ† ':''));h.innerHTML='<div style="cursor:pointer" onclick="S.showB=true;R()"><div style="font-weight:700;font-size:.9rem">'+mode+'Act '+S.act+' R'+S.rnd+' â–¾</div><div class="hearts">'+rH()+'</div></div><div style="display:flex;gap:5px;flex-wrap:wrap;align-items:center"><div class="stat"><div class="stat-lbl">Score</div><div class="stat-val gold">'+S.score+'</div></div><div class="stat"><div class="stat-lbl">Target</div><div class="stat-val">'+S.tgt+'</div></div><div class="stat"><div class="stat-lbl">Acts</div><div class="stat-val green">'+S.acts+'</div></div><div class="stat"><div class="stat-lbl">ðŸ’°</div><div class="stat-val gold">'+S.coins+'</div></div>'+(S.strk>0?'<div class="streak-ind">ðŸ”¥'+S.strk+' ('+S.mult.toFixed(1)+'x)</div>':'')+'</div>';d.appendChild(h);if(S.boss){const b=document.createElement('div');b.className='boss-box';b.innerHTML='<div class="name">âš  '+S.boss.n+'</div><div class="desc">'+S.boss.d+'</div>';bindHold(b,S.boss);d.appendChild(b);}if(S.gamblerMod){const gm=document.createElement('div');gm.style.cssText='background:var(--purple);border-radius:6px;padding:4px 8px;margin-bottom:6px;text-align:center;font-size:.7rem;color:#fff';gm.innerHTML='ðŸŽ² '+S.gamblerMod.n;d.appendChild(gm);}const ind=document.createElement('div');ind.className='ind-row';if(S.lockC)ind.innerHTML+='<div class="ind"><div class="color-sq '+S.lockC+'-c"></div></div>';else if(S.lockS)ind.innerHTML+='<div class="ind">'+SS[S.lockS]+'</div>';ind.innerHTML+='<div class="ind '+(S.usedD?'':'on')+'">â™»</div><div class="ind">ðŸ’¥'+S.bust+'</div>';if(S.lastS&&hM('suit_echo'))ind.innerHTML+='<div class="ind" style="background:var(--cyan);color:#000">Last: '+SS[S.lastS]+'</div>';if(S.lastC&&hM('suit_echo'))ind.innerHTML+='<div class="ind" style="background:var(--cyan);color:#000">Last: '+S.lastC.toUpperCase()+'</div>';if(hM('second_chance')&&!S.used2)ind.innerHTML+='<div class="ind glow">ðŸ›¡</div>';if(S.bR.includes('exact'))ind.innerHTML+='<div class="ind" style="background:var(--red);color:#fff">EXACT</div>';d.appendChild(ind);const ha=document.createElement('div');ha.className='hand-area';const sd=document.createElement('div');sd.className='score-box';const {sc,breakdown:bd}=calc();const scl=sc>S.bust?'bust':(S.bR.includes('exact')?(sc===S.tgt?'hit':''):((sc>=S.tgt?'hit':'')+(sc<=S.bust&&sc>S.bust-3?' danger':'')));sd.innerHTML='<div class="score-num '+scl+'">'+(hid?'??':sc)+'</div><div class="score-lbl">'+(sc>S.bust?'BUST!':(sc>=S.tgt?'HIT!':''))+'</div>';if(!hid&&(bd.suit||bd.entropy||bd.coll||bd.combo||bd.echo||bd.twins||bd.veteran||bd.triples)){let bdTxt='<div style="font-size:.6rem;color:var(--text2);margin-top:4px">';bdTxt+='Cards: '+bd.cards;if(bd.suit)bdTxt+=' <span style="color:var(--purple)">+'+bd.suit+' suit</span>';if(bd.entropy)bdTxt+=' <span style="color:var(--red)">+'+bd.entropy+' entropy</span>';if(bd.coll)bdTxt+=' <span style="color:var(--pink)">+'+bd.coll+' collector</span>';if(bd.combo)bdTxt+=' <span style="color:var(--gold)">+'+bd.combo+' combo</span>';if(bd.echo)bdTxt+=' <span style="color:var(--cyan)">+'+bd.echo+' echo</span>';if(bd.momentum)bdTxt+=' <span style="color:var(--green)">+'+bd.momentum+' momentum</span>';if(bd.twins)bdTxt+=' <span style="color:#ec4899">+'+bd.twins+' ðŸ‘¯</span>';if(bd.triples)bdTxt+=' <span style="color:#ec4899">+'+bd.triples+' 3x!</span>';if(bd.veteran)bdTxt+=' <span style="color:#f97316">+'+bd.veteran+' ðŸŽ–ï¸</span>';bdTxt+='</div>';sd.innerHTML+=bdTxt;}ha.appendChild(sd);const hc=document.createElement('div');hc.className='hand';S.hand.forEach((c,i)=>hc.appendChild(rC(c,i,true,hid)));if(!S.hand.length)hc.innerHTML='<div style="color:var(--text2);padding:24px">Draw cards</div>';ha.appendChild(hc);const ab=document.createElement('div');ab.className='actions';const free=hM('free_first')&&!S.usedF;const mkB=(cls,dis,txt,fn)=>{const b=document.createElement('button');b.className='btn '+cls+' btn-sm';b.disabled=dis;b.textContent=txt;b.onclick=fn;return b;};ab.appendChild(mkB('btn-primary',!canD,'Draw'+(free?' (Free)':''),()=>draw(false)));ab.appendChild(mkB('btn-secondary',!canDis,'Discard'+(S.sel.size?' ('+S.sel.size+')':''),()=>discS()));ab.appendChild(mkB('btn-success',!canK,'Knock',()=>knock()));ha.appendChild(ab);d.appendChild(ha);const da=document.createElement('div');da.className='deck-area';const dp=document.createElement('div');dp.className='deck-back'+(canD?'':' off');dp.innerHTML='<div class="deck-lbl">Deck</div><div class="deck-num">'+S.deck.length+'</div>';dp.onclick=()=>{if(canD)draw(false);};bindDeckHold(dp);da.appendChild(dp);if(hM('marked_cards')&&S.deck.length){const mp=document.createElement('div');mp.className='marked-box';mp.innerHTML='<div style="font-size:.5rem;color:var(--text2);margin-bottom:2px">TOP 3</div>';const top3=S.deck.slice(-3).reverse();top3.forEach(c=>{const isRed=c.suit==='hearts'||c.suit==='diamonds';mp.innerHTML+='<div class="marked-card" style="color:'+(isRed?'#dc2626':'#1f2937')+'">'+c.rank+' '+SS[c.suit]+'</div>';});da.appendChild(mp);}const dc=document.createElement('div');const topDisc=S.disc.length?S.disc[S.disc.length-1]:null;dc.className='discard'+(S.disc.length?' has':'')+(!S.usedD&&S.disc.length?' free':'')+(topDisc?.cursed?' cursed':'');if(S.disc.length){dc.innerHTML=rCHTML(topDisc)+'<div class="discard-cnt">'+S.disc.length+'</div>'+(!S.usedD?'<div class="discard-free">FREE</div>':'');}else dc.innerHTML='<div style="color:var(--text2)">0</div>';dc.onclick=()=>{if(!S.usedD&&S.disc.length)draw(true);};da.appendChild(dc);d.appendChild(da);if(S.mods.length){const mb=document.createElement('button');mb.className='mods-btn';mb.innerHTML='Mods '+S.mods.length;mb.onclick=()=>{S.showM=true;R();};d.appendChild(mb);}if(S.relics.length){const rb=document.createElement('button');rb.className='relics-btn';rb.textContent='ðŸº'+S.relics.length;rb.onclick=()=>{S.showR=true;R();};d.appendChild(rb);}if(S.spirits.length){const spb=document.createElement('button');spb.className='spirit-btn';spb.textContent='ðŸ‘»'+S.spirits.length;spb.onclick=()=>{S.showSp=true;R();};d.appendChild(spb);}app.appendChild(d);}
function rCHTML(c){if(!c)return'';const isRed=c.suit==='hearts'||c.suit==='diamonds';const col=isRed?'#dc2626':'#1f2937';let up='';if(c.upgrade){const cols={gilded:'var(--gold)',wild:'var(--purple)',glass:'var(--cyan)',mult:'var(--red)'};up='<div class="card-upgrade" style="background:'+cols[c.upgrade]+';color:'+(c.upgrade==='gilded'||c.upgrade==='glass'?'#000':'#fff')+'">'+c.upgrade[0].toUpperCase()+'</div>';}let mk='';if(c.mark){const mark=MARKS.find(m=>m.id===c.mark);if(mark)mk='<div class="card-mark">'+mark.sym+'</div>';}let drunk='';if(S.drunkCard===c.id)drunk='<div style="position:absolute;bottom:12px;left:50%;transform:translateX(-50%);font-size:.5rem">ðŸº</div>';return'<div class="mini" style="color:'+col+'"><span>'+c.rank+'</span><span>'+SS[c.suit]+'</span></div><div class="suit" style="color:'+col+'">'+SS[c.suit]+'</div><div class="mini-b" style="color:'+col+'"><span>'+c.rank+'</span><span>'+SS[c.suit]+'</span></div>'+up+mk+drunk;}
function rC(c,idx,inH,hid){const d=document.createElement('div');const isRed=c.suit==='hearts'||c.suit==='diamonds';d.className='card'+(isRed?' red':' black');if(inH&&S.sel.has(idx))d.classList.add('sel');if(c.cursed)d.classList.add('cursed');if(c.upgrade)d.classList.add(c.upgrade);const echoMatch=hM('suit_echo')&&((S.lastS&&c.suit===S.lastS)||(S.lastC&&((S.lastC==='red'&&isRed)||(S.lastC==='black'&&!isRed))));if(echoMatch&&!c.cursed)d.classList.add('suit-echo');if(c.mark){const mk=MARKS.find(m=>m.id===c.mark);if(mk)d.style.boxShadow='0 0 8px '+mk.col;}if(hid){d.style.background='linear-gradient(135deg,#1e3a8a,#312e81)';d.innerHTML='<span style="font-size:1.3rem;color:rgba(255,255,255,.4)">?</span>';d.classList.remove('red','black');}else{d.innerHTML=rCHTML(c);const v=document.createElement('div');v.className='card-val';v.textContent=cV(c);d.appendChild(v);}if(inH){d.onclick=()=>togC(idx);let holdInfo=null;if(c.cursed)holdInfo={cursed:true};else if(c.mark){const mk=MARKS.find(m=>m.id===c.mark);holdInfo={n:mk.sym+' '+mk.n,d:mk.d+(c.mark==='flame'?' ('+((c.markUses||0))+'/3 uses)':'')};}else if(c.upgrade)holdInfo={n:c.upgrade.toUpperCase(),d:c.upgrade==='gilded'?'+3 value (+5 with Midas relic)':c.upgrade==='wild'?'Counts as any suit':c.upgrade==='glass'?'2x value but breaks after use':c.upgrade==='mult'?'Value counts twice in scoring':''};if(holdInfo)bindHold(d,holdInfo);}return d;}
function rH(){let h='';for(let i=0;i<S.maxS;i++)h+='<svg class="heart '+(i<S.stab?'on':'off')+'" viewBox="0 0 24 24" fill="currentColor"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>';return h;}
function rEnd(app){const r=S.res;const bd=r.bd||{};const d=document.createElement('div');d.className='screen active';let bdHtml='';if(bd.cards){bdHtml='<div style="background:var(--bg2);border-radius:6px;padding:8px;margin-bottom:8px;font-size:.7rem"><div style="margin-bottom:4px;color:var(--text2)">Score Breakdown</div>';bdHtml+='<div>Cards: <b>'+bd.cards+'</b></div>';if(bd.suit)bdHtml+='<div style="color:var(--purple)">Suit mods: <b>+'+bd.suit+'</b></div>';if(bd.entropy)bdHtml+='<div style="color:var(--red)">Entropy mods: <b>+'+bd.entropy+'</b></div>';if(bd.coll)bdHtml+='<div style="color:var(--pink)">Collector: <b>+'+bd.coll+'</b></div>';if(bd.combo)bdHtml+='<div style="color:var(--gold)">Combo King: <b>+'+bd.combo+'</b></div>';if(bd.echo)bdHtml+='<div style="color:var(--cyan)">Echo Chamber: <b>+'+bd.echo+'</b></div>';if(bd.momentum)bdHtml+='<div style="color:var(--green)">Momentum: <b>+'+bd.momentum+'</b></div>';if(bd.rainbow)bdHtml+='<div style="color:var(--pink)">Rainbow 2x: <b>+'+bd.rainbow+'</b></div>';if(bd.suitColl)bdHtml+='<div style="color:var(--gold)">Suit Collector: <b>+'+bd.suitColl+'</b></div>';bdHtml+='</div>';}d.innerHTML='<div style="text-align:center;width:100%;max-width:280px"><h2 style="font-size:1.8rem;color:'+(r.ok?'var(--green)':'var(--red)')+'">'+(r.bust?'BUST!':r.ok?(r.saved?'SAVED!':'SUCCESS!'):'MISS')+'</h2>'+(r.saved?'<p style="color:var(--gold);font-size:.8rem">ðŸ›¡ Second Chance!</p>':'')+bdHtml+'<div class="result-box"><div class="result-row"><span>Final Score</span><span>'+r.sc+'</span></div><div class="result-row"><span>Target</span><span>'+S.tgt+'</span></div><div class="result-row"><span>Base</span><span>'+r.base+'</span></div><div class="result-row"><span>Bonus</span><span style="color:var(--green)">+'+r.bonus+'</span></div><div class="result-row"><span>Mult</span><span style="color:var(--gold)">Ã—'+r.mult.toFixed(1)+'</span></div><div class="result-row total"><span>Round</span><span style="color:var(--gold)">+'+r.rs+'</span></div><div class="result-row" style="color:var(--gold)"><span>ðŸ’°</span><span>+'+r.coinGain+'</span></div></div><div class="hearts" style="justify-content:center;margin:12px 0">'+rH()+'</div>'+(r.ret?'<div style="color:var(--cyan);font-size:.75rem;margin-bottom:10px">ðŸ“Œ Kept: '+r.ret.rank+SS[r.ret.suit]+'</div>':'')+'<button class="btn btn-primary" onclick="adv()">Continue</button></div>';app.appendChild(d);}
function rShop(app){const d=document.createElement('div');d.className='screen active';d.innerHTML='<h2>ðŸª Shop</h2><div style="color:var(--gold);font-size:1.3rem;font-weight:700;margin:8px 0">ðŸ’° '+S.coins+'</div><div class="shop-wrap" id="sw"></div><button class="btn btn-secondary" style="margin-top:12px" onclick="skipShop()">Continue</button>';app.appendChild(d);const sw=document.getElementById('sw');S.shopItems.forEach(item=>{const can=S.coins>=item.cost;const si=document.createElement('div');si.className='shop-item'+(can?'':' disabled');si.innerHTML='<div><div class="s-name">'+item.n+'</div><div class="s-desc">'+item.d+'</div></div><div class="s-cost">'+(item.cost||'FREE')+'</div>';if(can)si.onclick=()=>buyShop(item);sw.appendChild(si);});}
function rPick(app){const d=document.createElement('div');d.className='screen active';const title={upgrade:'Upgrade Card',remove:'Remove Card',mark:'Mark Card'}[S.pickAction]||'Pick Card';const subtitle=S.pickUpgrade?S.pickUpgrade.toUpperCase():(S.pickMark?MARKS.find(m=>m.id===S.pickMark)?.sym+' '+S.pickMark.toUpperCase():'');d.innerHTML='<h2>'+title+'</h2><p style="color:var(--text2);font-size:.8rem;margin-bottom:12px">'+subtitle+'</p><div class="upgrade-pick" id="up"></div><button class="btn btn-secondary" style="margin-top:12px" onclick="S.pickUpgrade=null;S.pickMark=null;S.pickAction=null;S.scr=\'shop\';R()">Cancel</button>';app.appendChild(d);const up=document.getElementById('up');const indices=S.deck.map((_,i)=>i);for(let i=indices.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[indices[i],indices[j]]=[indices[j],indices[i]];}const picks=indices.slice(0,8);picks.forEach(idx=>{const c=S.deck[idx];const isRed=c.suit==='hearts'||c.suit==='diamonds';const pc=document.createElement('div');pc.className='upgrade-card-pick'+(isRed?' red':' black')+(c.upgrade?' '+c.upgrade:'');let extra='';if(c.mark){const mk=MARKS.find(m=>m.id===c.mark);if(mk)extra=mk.sym;}pc.innerHTML=c.rank+'<br>'+SS[c.suit]+(c.upgrade?'<div style="font-size:.4rem;color:var(--gold)">'+c.upgrade[0].toUpperCase()+'</div>':'')+(extra?'<div style="font-size:.5rem">'+extra+'</div>':'');pc.onclick=()=>applyCardAction(idx);up.appendChild(pc);});}
function rMod(app){const d=document.createElement('div');d.className='screen active';const canReroll=S.coins>=3;d.innerHTML='<h2>Choose Modifier</h2><p style="color:var(--text2);font-size:.75rem;margin-bottom:12px">Tap to select, hold for details</p><div class="mod-choices" id="mc"></div><div style="display:flex;gap:8px;margin-top:12px"><button class="btn btn-secondary" onclick="skipM()">Skip</button><button class="btn btn-gold'+(canReroll?'':' disabled')+'" onclick="'+(canReroll?'rerollMods()':'')+'" '+(canReroll?'':'disabled')+'>ðŸ”„ Reroll (3ðŸ’°)</button></div>';app.appendChild(d);const mc=document.getElementById('mc');S.modC.forEach(m=>{const c=document.createElement('div');c.className='mod-choice cat-'+m.c;c.innerHTML='<div class="cat">'+m.c+'</div><div class="name">'+m.n+'</div><div class="desc">'+m.d+'</div>';c.onclick=()=>selM(m);bindHold(c,m);mc.appendChild(c);});}
function rerollMods(){if(S.coins<3)return;S.coins-=3;playSound('coin');genMods();R();}
function rBoss(app){const b=S.boss;const d=document.createElement('div');d.className='screen active';d.innerHTML='<div style="text-align:center"><div style="color:var(--red);font-size:.9rem;margin-bottom:6px">âš  BOSS âš </div><h2 style="font-size:2rem;color:var(--red);margin-bottom:10px">'+b.n+'</h2><p style="font-size:.9rem;color:#fff;margin-bottom:6px;max-width:280px">'+b.d+'</p><p style="color:var(--text2);font-style:italic;margin-bottom:20px;font-size:.75rem">"'+b.f+'"</p><button class="btn btn-danger" onclick="sRnd(S.res?.ret)">Fight</button></div>';app.appendChild(d);}
function rOver(app){const d=document.createElement('div');d.className='screen active';const txt=S.isEndless?'Endless: Act '+S.act:(S.curChal?'Challenge Failed':'Game Over');const rs=S.runStats||{};d.innerHTML='<div style="text-align:center"><h2 style="font-size:2rem;color:var(--red)">'+txt+'</h2><div style="background:var(--bg2);border-radius:10px;padding:14px;max-width:240px;margin:16px auto"><div style="color:var(--text2);font-size:.8rem">Final Score</div><div style="font-size:2rem;font-weight:700;color:var(--gold)">'+S.score+'</div></div><div style="background:var(--bg2);border-radius:10px;padding:12px;max-width:240px;margin:0 auto 16px;text-align:left"><div style="font-size:.75rem;font-weight:600;color:var(--text2);margin-bottom:8px;text-align:center">ðŸ“Š Run Statistics</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.7rem"><div>Best Hand:</div><div style="color:var(--gold);text-align:right">'+(rs.highHand||0)+'</div><div>Coins Earned:</div><div style="color:var(--gold);text-align:right">ðŸ’°'+(rs.totalCoins||0)+'</div><div>Rounds Won:</div><div style="color:var(--green);text-align:right">'+(rs.roundsWon||0)+'</div><div>Rounds Lost:</div><div style="color:var(--red);text-align:right">'+(rs.roundsLost||0)+'</div><div>Mods Collected:</div><div style="color:var(--purple);text-align:right">'+(rs.modsCollected||0)+'</div><div>Bosses Beaten:</div><div style="color:var(--orange);text-align:right">'+(rs.bossesBeaten||0)+'</div></div></div><div style="display:flex;gap:6px;justify-content:center"><button class="btn btn-secondary" onclick="S.scr=\'menu\';R()">Menu</button><button class="btn btn-primary" onclick="start()">Retry</button></div></div>';app.appendChild(d);}
function rWin(app){const d=document.createElement('div');d.className='screen active';const txt=S.curChal?'Challenge Complete!':'Victory!';const rs=S.runStats||{};d.innerHTML='<div style="text-align:center"><h2 style="font-size:2rem;color:var(--gold)">ðŸ† '+txt+' ðŸ†</h2><div style="background:var(--bg2);border-radius:10px;padding:14px;max-width:240px;margin:16px auto"><div style="color:var(--text2);font-size:.8rem">Final Score</div><div style="font-size:2rem;font-weight:700;color:var(--gold)">'+S.score+'</div><div class="hearts" style="justify-content:center;margin-top:6px">'+rH()+'</div></div><div style="background:var(--bg2);border-radius:10px;padding:12px;max-width:240px;margin:0 auto 16px;text-align:left"><div style="font-size:.75rem;font-weight:600;color:var(--text2);margin-bottom:8px;text-align:center">ðŸ“Š Run Statistics</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:.7rem"><div>Best Hand:</div><div style="color:var(--gold);text-align:right">'+(rs.highHand||0)+'</div><div>Coins Earned:</div><div style="color:var(--gold);text-align:right">ðŸ’°'+(rs.totalCoins||0)+'</div><div>Rounds Won:</div><div style="color:var(--green);text-align:right">'+(rs.roundsWon||0)+'</div><div>Rounds Lost:</div><div style="color:var(--red);text-align:right">'+(rs.roundsLost||0)+'</div><div>Mods Collected:</div><div style="color:var(--purple);text-align:right">'+(rs.modsCollected||0)+'</div><div>Bosses Beaten:</div><div style="color:var(--orange);text-align:right">'+(rs.bossesBeaten||0)+'</div></div></div><div style="display:flex;gap:6px;justify-content:center;flex-wrap:wrap"><button class="btn btn-secondary" onclick="S.scr=\'menu\';R()">Menu</button><button class="btn btn-success" onclick="continueEndless()">âˆž Continue</button></div></div>';app.appendChild(d);}
function rSet(app){const o=document.createElement('div');o.className='modal-bg';o.onclick=e=>{if(e.target===o){S.showS=false;sv();R();}};const m=document.createElement('div');m.className='modal';const seedCode=S.runSeed?(S.dk||'STD').toUpperCase().slice(0,3)+'-'+S.asc+'-'+S.runSeed:'';m.innerHTML='<h3>âš™ Settings</h3><div style="margin-bottom:14px"><div style="font-size:.7rem;color:var(--text2);margin-bottom:6px">VOLUME</div><div class="slider-wrap"><input type="range" class="slider" min="0" max="100" value="'+S.sVol+'" oninput="S.sVol=parseInt(this.value)"><span>'+S.sVol+'%</span></div></div>'+(seedCode?'<div style="margin-bottom:14px"><div style="font-size:.7rem;color:var(--text2);margin-bottom:6px">SEED</div><div id="seedBox" style="display:flex;align-items:center;gap:8px;background:var(--bg3);padding:8px 12px;border-radius:6px"><code style="flex:1;font-family:monospace;font-size:.85rem;color:var(--cyan)">'+seedCode+'</code></div></div>':'')+'<div style="display:flex;flex-direction:column;gap:6px"><button class="btn btn-secondary" onclick="S.showS=false;sv();R()">Close</button><button class="btn btn-danger" onclick="if(confirm(\'Quit run?\')){S.showS=false;clrG();S.scr=\'menu\';R();}">Quit</button></div>';o.appendChild(m);app.appendChild(o);if(seedCode){const sb=document.getElementById('seedBox');const cb=document.createElement('button');cb.style.cssText='background:var(--bg2);border:1px solid var(--border);border-radius:4px;padding:4px 8px;cursor:pointer;color:var(--text)';cb.textContent='ðŸ“‹';cb.onclick=()=>{navigator.clipboard.writeText(seedCode);cb.textContent='âœ“';setTimeout(()=>cb.textContent='ðŸ“‹',1500);};sb.appendChild(cb);}}
function rML(app){const o=document.createElement('div');o.className='modal-bg';o.onclick=e=>{if(e.target===o){S.showM=false;R();}};const m=document.createElement('div');m.className='modal';m.innerHTML='<h3>Mods ('+S.mods.length+')</h3><div class="mod-list" id="ml"></div><button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="S.showM=false;R()">Close</button>';o.appendChild(m);app.appendChild(o);const ml=document.getElementById('ml');S.mods.forEach(mod=>{const it=document.createElement('div');it.className='mod-item cat-'+mod.c+(S.disM===mod.id?' off':'');it.innerHTML='<div class="mod-name">'+mod.n+(S.disM===mod.id?' (OFF)':'')+'</div><div class="mod-desc">'+mod.d+'</div>';bindHold(it,mod);ml.appendChild(it);});}
function rRL(app){const o=document.createElement('div');o.className='modal-bg';o.onclick=e=>{if(e.target===o){S.showR=false;R();}};const m=document.createElement('div');m.className='modal';m.innerHTML='<h3>ðŸº Relics ('+S.relics.length+')</h3><div id="rl"></div><button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="S.showR=false;R()">Close</button>';o.appendChild(m);app.appendChild(o);const rl=document.getElementById('rl');S.relics.forEach(rid=>{const r=RELICS.find(x=>x.id===rid);if(r)rl.innerHTML+='<div class="relic"><div class="r-name">'+r.n+'</div><div class="r-desc">'+r.d+'</div></div>';});}
function rBL(app){const o=document.createElement('div');o.className='modal-bg';o.onclick=e=>{if(e.target===o){S.showB=false;R();}};const m=document.createElement('div');m.className='modal';let content='<h3>ðŸ‘‘ Run Progress</h3><div style="margin-bottom:12px;padding:10px;background:var(--bg3);border-radius:8px"><div style="font-size:.7rem;color:var(--text2)">Current</div><div style="font-size:1.1rem;font-weight:700">Act '+S.act+' Round '+S.rnd+'</div></div>';if(S.bossesBeaten.length){content+='<div style="font-size:.8rem;font-weight:600;margin-bottom:8px;color:var(--gold)">Bosses Defeated ('+S.bossesBeaten.length+')</div><div class="mod-list">';S.bossesBeaten.forEach(b=>{content+='<div class="mod-item" style="border-left-color:var(--red)"><div class="mod-name">'+b.n+'</div><div class="mod-desc">Act '+b.a+'</div></div>';});content+='</div>';}else{content+='<div style="color:var(--text2);font-size:.8rem;text-align:center;padding:16px">No bosses defeated yet</div>';}content+='<button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="S.showB=false;R()">Close</button>';m.innerHTML=content;o.appendChild(m);app.appendChild(o);}
function rDL(app){const o=document.createElement('div');o.className='modal-bg';o.onclick=e=>{if(e.target===o){S.showD=false;R();}};const m=document.createElement('div');m.className='modal';m.style.maxWidth='380px';const allCards=[...S.deck,...S.hand,...S.disc];const bySuit={hearts:[],diamonds:[],clubs:[],spades:[]};allCards.forEach(c=>{if(bySuit[c.suit])bySuit[c.suit].push(c);});let content='<h3>ðŸƒ Deck Viewer</h3><div style="font-size:.7rem;color:var(--text2);margin-bottom:12px;text-align:center">Deck: '+S.deck.length+' | Hand: '+S.hand.length+' | Discard: '+S.disc.length+'</div>';SUITS.forEach(suit=>{const cards=bySuit[suit].sort((a,b)=>RV[b.rank]-RV[a.rank]);const isRed=suit==='hearts'||suit==='diamonds';content+='<div style="margin-bottom:10px"><div style="font-size:.75rem;font-weight:600;color:'+(isRed?'#dc2626':'var(--text)')+';margin-bottom:4px">'+SS[suit]+' '+suit.charAt(0).toUpperCase()+suit.slice(1)+' ('+cards.length+')</div><div style="display:flex;flex-wrap:wrap;gap:3px">';cards.forEach(c=>{const inHand=S.hand.includes(c);const inDisc=S.disc.includes(c);let bg='var(--bg3)';let border='';if(inHand){bg='var(--green)';border='border:1px solid var(--green);';}else if(inDisc){bg='var(--bg2)';border='border:1px dashed var(--text2);';}let extra='';if(c.cursed)extra+='â˜ ';if(c.upgrade)extra+=({gilded:'âœ¦',wild:'â˜…',glass:'â—‡',mult:'Ã—'}[c.upgrade]||'');if(c.mark){const mk=MARKS.find(x=>x.id===c.mark);if(mk)extra+=mk.sym;}content+='<div style="background:'+bg+';'+border+'padding:2px 5px;border-radius:3px;font-size:.65rem;font-weight:600;color:'+(isRed&&!inHand?'#dc2626':'var(--text)')+'">'+c.rank+extra+'</div>';});content+='</div></div>';});content+='<div style="font-size:.6rem;color:var(--text2);margin-top:8px;text-align:center"><span style="color:var(--green)">â– </span> In Hand | <span style="border:1px dashed var(--text2);padding:0 3px">â€”</span> Discarded</div>';m.innerHTML=content;o.appendChild(m);app.appendChild(o);}
function rSpL(app){const o=document.createElement('div');o.className='modal-bg';o.onclick=e=>{if(e.target===o){S.showSp=false;R();}};const m=document.createElement('div');m.className='modal';let content='<h3>ðŸ‘» Spirits ('+S.spirits.length+'/3)</h3>';if(S.spirits.length){S.spirits.forEach(sid=>{const sp=SPIRITS.find(s=>s.id===sid);if(!sp)return;const loyalty=S.spiritLoyalty[sid]||0;const isLoyal=loyalty>=5;content+='<div class="spirit-item"><div class="sp-name">'+sp.sym+' '+sp.n+(isLoyal?' â­':'')+'</div><div class="sp-desc">'+sp.d+'</div>'+(isLoyal?'<div class="sp-loyalty" style="color:var(--green)">LOYAL: '+sp.loyalty+'</div>':'<div class="sp-loyalty">Loyalty: '+loyalty+'/5</div>')+'<div style="font-size:.55rem;color:var(--red);margin-top:2px">Abandons if: '+sp.abandon+'</div></div>';});}else{content+='<div style="color:var(--text2);font-size:.8rem;text-align:center;padding:16px">No spirits yet. Find them in shops!</div>';}content+='<button class="btn btn-secondary" style="width:100%;margin-top:12px" onclick="S.showSp=false;R()">Close</button>';m.innerHTML=content;o.appendChild(m);app.appendChild(o);}
ld();R();
</script></body></html>
